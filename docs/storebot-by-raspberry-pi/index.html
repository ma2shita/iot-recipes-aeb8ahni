
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>近づくと音声で自動応答する店番ロボット</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://soracom.github.io/iot-recipes/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-66865146-33"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="storebot-by-raspberry-pi"
                  title="近づくと音声で自動応答する店番ロボット"
                  environment="web"
                  feedback-link="https://soracom.jp/products/kit/gps_multiunit/">
    
      <google-codelab-step label="近づくと音声で自動応答する店番ロボット" duration="1">
        <p>公開日: 2020年8月</p>
<p>レシピ難易度：★★☆☆☆</p>
<p>イベントに出展の困りごとが「スタッフのシフト」。応対を欠かすことが無いように人数や休憩時間に気を配る必要があります。本レシピはIoTを活用してお客様が近づいたら音声で展示物を紹介しつつ、応答した実績をチャット等で共有する「自動店番ロボット」で、そのお悩みを解決します。</p>
<h2 is-upgraded>全体構成</h2>
<p class="image-container"><img style="width: 601.70px" src="img/f63abf88f0dedda1.png"></p>
<h2 is-upgraded>本レシピを行うのに必要な時間、概算費用</h2>
<p>本レシピは以下の通りです。</p>
<ul>
<li>必要な時間: 約1時間</li>
<li>概算費用: 約24,500円</li>
</ul>
<p>※ 概算費用: ハードウェアや SORACOM を始めとした各種サービスの概ねの費用 (税や送料などの付帯費用や無料枠適用は考慮しないものとしています)</p>
<h2 is-upgraded>このコンテンツの進め方</h2>
<p>ページの内容を読み、また作業を行ったら右下の［Next］を押して次のステップへ進みます。また、［Back］を使って戻ったり、左のナビゲーションメニューでもページの移動が可能です。</p>
<p>左上の［×］を押してコンテンツを終了することができます。また、ページを開きなおすことで再開できます。ページのアドレスはブラウザの［履歴］メニューを利用してください。</p>

<aside class="warning"><p>本コンテンツは現状のままで提供され、株式会社ソラコムは、誤りがないことの保証を含め、明示であると黙示であるとを問わず、本コンテンツの記載内容につき、いかなる種類の表明も保証も行いません。</p>
<p>掲載情報の閲覧及び利用により、利用者自身、もしくは第三者が被った損害に対して、直接的、間接的を問わず、株式会社ソラコムは責任を負いかねます。</p>
<p>本コンテンツを実践する中で用意された機器、利用されたサービスについてのご質問は、それぞれの機器やサービスの提供元にお問い合わせをお願いします。機器やサービスの仕様は、本コンテンツ作成当時のものです。</p>
<p>株式会社ソラコムが提供する機器・サービスについてのご質問は、 <a href="https://soracom.jp/contact/" target="_blank">https://soracom.jp/contact/</a> をご確認の上、適切な窓口へのお問い合わせをお願いします。機器・サービスご利用前の導入相談は <a href="https://soracom.jp/contact/contactsales/" target="_blank">https://soracom.jp/contact/contactsales/</a> に、機器・サービスご利用開始後のサポートは、SORACOMユーザーコンソール内の<a href="https://soracom.zendesk.com/hc/ja/requests/" target="_blank">サポートサイトから「リクエストを送信」</a>(要ログイン)にてお問い合わせください。</p>
<p>本ドキュメントは <a href="https://github.com/googlecodelabs/tools" target="_blank">CLaaT</a> を用いて制作しています</p>
<p>Copyright (c) 2020 SORACOM, INC.</p>
</aside>



      </google-codelab-step>
    
      <google-codelab-step label="準備" duration="1">
        <p>本レシピを行うためには以下のものをご用意ください。</p>
<h2 is-upgraded>ハードウェア</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>品名</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>数量</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>価格</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>購入先</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>IoT 体験キット 〜距離測定センサー〜</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>15,580円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/products/kit/sensor_kit/" target="_blank">ソラコム</a></p>
</td><td colspan="1" rowspan="1"><p>キットの中には以下のものが含まれています。(それぞれを個別に準備しても構いません)</p>
<ul>
<li>Raspberry Pi 3 Model B+ 本体 x 1</li>
<li>Raspberry Pi 3 用電源アダプタ x 1</li>
<li>microSD (16GB以上) x 1</li>
<li>超音波距離センサー (3.3V対応) x 1</li>
<li>ジャンパワイヤ (オス - メス) x 4</li>
<li>ブレッドボード x 1</li>
<li>AK-020 (USB ドングル型モデム) x 1</li>
<li>SORACOM 特定地域向け IoT SIM (plan-D 標準サイズ) x 1</li>
</ul>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>microSD カードリーダー</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約1,600円</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>microSD にパソコンから書き込めるようにするために必要です。(例: <a href="https://www.amazon.co.jp/dp/B00TMYLK1I/" target="_blank">エレコム カードリーダー MR3-C008BK</a>)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>有線 LAN (USB 型のアダプタ等形状問わず)</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約1,600円</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>パソコンと Raspberry Pi の通信に必要です。(例: <a href="https://www.amazon.co.jp/dp/B07VG66XX3/" target="_blank">BUFFALO 有線LANアダプター LUA4-U3-AGTE-NBK</a>)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>スピーカー</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約5,000円</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>音声を流すために利用します。動画内では<a href="https://www.amazon.co.jp/dp/B01NAVANRX" target="_blank">Anker社のSoundcore2を利用</a>しています。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>オーディオケーブル</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約700円</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>スピーカーと Raspberry Pi の接続に利用します。Raspberry Pi 側は 3.5mm サイズです。(例: <a href="https://www.amazon.co.jp/dp/B00NO73IN2/" target="_blank">Amazon ベーシック オーディオケーブル</a>)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>パソコン</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><ul>
<li>インターネット接続が可能でサイトへの接続が自由であること。</li>
<li>Google Chrome 等の最新ブラウザーが利用可能な事。</li>
</ul>
</td></tr>
</table>
<p>※ 金額はレシピ作成時となります。ソラコムで販売している金額は税抜き・送料別です。</p>
<aside class="special"><p><strong>準備するものについて</strong></p>
<p>Raspberry Piは4でも動作します。その場合は4GB以上で、ACアダプタも対応するものをご用意ください。</p>
<p>IoT体験キット内に同梱されている超音波距離センサーは<a href="https://www.switch-science.com/catalog/5512/" target="_blank">US-100</a>を利用しています。</p>
<p>冒頭の動画ではブレッドボードを使わずに超音波距離センサーとRaspberry Piを接続しています。その場合は別途「<a href="https://www.switch-science.com/catalog/2295/" target="_blank">メス―メス型ジャンパワイヤ</a>」を4本ご用意ください。</p>
</aside>
<h2 is-upgraded>その他必要なもの</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>必要なもの</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>費用</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>作成方法など</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SORACOM アカウント</p>
</td><td colspan="1" rowspan="1"><p>無料※</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.github.io/iot-recipes/create-account-soracom-jp/" target="_blank">SORACOM アカウントの作成 (JP)</a></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>WiFi環境</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>Raspberry Piにソフトウェアをダウンロードする際に利用します。ログインポータル(Webによる認証)が無いWiFiをご用意ください。</p>
<p>※セットアップが終わった後はSORACOM Airでインターネットにつながるため不要となります。</p>
</td></tr>
</table>
<p>※ アカウント作成・維持の費用の料金です。</p>
<aside class="special"><p><strong>AWS の手順について</strong></p>
<p>当レシピでは AWS の設定をします。これらの利用経験があるとスムーズです。なお、わかりやすさのため当社で検証した当時の内容をスクリーンショット付きで掲載しておりますが、公式な手順は各社のドキュメントをご確認ください。</p>
</aside>
<h3 is-upgraded>すでに AWS アカウントを持っている場合の確認事項</h3>
<ul>
<li>ルートアカウントを利用する場合：特に確認すべき事項はありません。先に進んでください。</li>
<li>IAM アカウントを利用する場合：<strong>AWS Lambda の関数作成および実行権限の有無</strong>を確認してください。また、必要権限の解説およびサポートは致しかねますが、AdministratorAccess ポリシーが割り当てられていれば当レシピは完遂可能です (同ポリシーを割り当てたことによる影響については IAM アカウント管理者にご相談ください)</li>
</ul>
<h2 is-upgraded>設置に利用したもの</h2>
<p>本レシピで設置時に利用した部材です。必須ではありませんがご参考にお使いください。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>品名</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>数量</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>スマートフォンホルダー</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>超音波距離センサーの取り付けに利用。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>両面テープ等の固定用部材</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>超音波距離センサーをスマートフォンホルダーに固定する際に利用。</p>
</td></tr>
</table>


      </google-codelab-step>
    
      <google-codelab-step label="IoT 体験キット 〜距離測定センサー〜 が届いたら" duration="5">
        <p>IoT 体験キット 〜距離測定カメラ〜(以下、IoT 体験キット) に同梱されている SIM は、SORACOM に登録することで通信が出来るようになります。そのため、まず IoT 体験キットに同梱されている SIM を SORACOM へ登録をしましょう。<br>※ すでに登録済み、もしくは登録済みの別の SIM を利用する場合は次へお進みください。</p>
<p>登録の方法は<a href="https://soracom.github.io/iot-recipes/register-ordering-sim-jp/#0" target="_blank">発注済みの SIM を登録する</a>をご覧ください。約5分で完了します。</p>
<p>登録が完了すると SIM 管理の一覧に表示されますので、確認ください。</p>
<p class="image-container"><img style="width: 601.70px" src="img/8ab59a68e0f87ac4.png"></p>
<aside class="special"><p><strong>SORACOM の便利な使い方: SIM の「名前」機能</strong></p>
<p>SIM には「名前」を付けることができ、これで整理が可能です。特に複数の SIM (ボタン含む) をお持ちの際には、名前を付けることを強くお勧めいたします。</p>
<p>名前の付け方は <a href="https://dev.soracom.io/jp/start/console/#name_tag" target="_blank">SIM への名前の付け方</a>をご覧ください。</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Raspberry Pi 用 OS &#34;Raspbian&#34; を microSD に書き込む" duration="20">
        <h2 is-upgraded>Raspberry Pi Imager をダウンロードします。</h2>
<p><a href="https://www.raspberrypi.org/downloads/" target="_blank">Raspberry Pi のダウンロードページ</a>を開き、OS に合った Raspberry Pi Imager をダウンロードします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/76b9ac7e545f7b40.png"></p>
<h2 is-upgraded>Raspberry Pi Imager をインストールします。</h2>
<h3 is-upgraded>Windows の場合</h3>
<p>ダウンロードした <code>imager.exe</code> を実行し、インストーラーの指示に従ってインストールを完了します。</p>
<p class="image-container"><img style="width: 596.00px" src="img/a86cce01b57fd6c0.png"></p>
<p>インストール完了時の &#34;Run Raspberry Pi Imager&#34; はチェックを外した状態で［Finish］をクリックします。</p>
<h3 is-upgraded>macOS の場合</h3>
<p>ダウンロードした <code>imager.dmg</code> を実行し、 <strong>Raspberry Pi Imager</strong> を Applications (アプリケーション) フォルダへコピーします。</p>
<p class="image-container"><img style="width: 562.00px" src="img/93f4bbaf28bf9e1c.png"></p>
<aside class="special"><p>インストールが完了したら、Finder のデバイスに表示されている <strong>Raspberry Pi Imager</strong> は不要となります。取出しをしてください。</p>
</aside>
<h2 is-upgraded>Raspberry Pi Imager を利用して microSD カードに書き込む</h2>
<p>手順は動画をご覧ください。</p>
<iframe class="youtube-video" src="https://www.youtube.com/embed/J024soVgEeM?rel=0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h3 is-upgraded>注意点: STEP2 における Raspberry Pi Imager の起動の方法</h3>
<table>
<tr><td colspan="1" rowspan="1"><p>Windows</p>
</td><td colspan="1" rowspan="1"><p>［スタートメニュー］&gt; &#34;Raspberry Pi Imager&#34;</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>macOS</p>
</td><td colspan="1" rowspan="1"><p>［Finder］&gt;［アプリケーション フォルダ］&gt; &#34;Raspberry Pi Imager&#34;</p>
</td></tr>
</table>
<p>macOS で初回起動時に「インターネットからダウンロードされたアプリケーションです」のダイアログが表示された場合は［OK］をクリックして進めてください。</p>
<p>書き込みが完了したら microSD カードを取り出してください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="microSD に追加の設定を書き込む / SSH サービス有効化と Wi-Fi の事前設定" duration="10">
        <p>Raspberry Pi の起動時に、Wi-Fi への接続と SSH サービスの待ち受けをするように設定を加えます。</p>
<h2 is-upgraded>ファイルの作成</h2>
<p>以下二つのファイルを作成します。テキストエディタで作成してください。</p>
<ul>
<li>wpa_supplicant.conf</li>
<li>ssh</li>
</ul>
<h3 is-upgraded>wpa_supplicant.conf</h3>
<pre><code>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
country=JP
update_config=1

network={
    ssid=&#34;YOUR_WIFI_AP_SSID1&#34;
    psk=&#34;password1&#34;
}

network={
    ssid=&#34;YOUR_WIFI_AP_SSID2&#34;
    psk=&#34;password2&#34;
}</code></pre>
<p>このファイルは Raspberry Pi 起動時に接続する Wi-Fi のアクセスポイントをあらかじめ書いておくことができます。 <code>YOUR_WIFI_AP_SSID1</code> や <code>password1</code> を皆さんのご家庭もしくは職場の環境に合わせて書き換えてください。</p>
<ul>
<li><code>network={...</code> の <code>ssid=</code> には SSID を、 <code>psk=</code> にはパスフレーズを書きます。</li>
<li><code>network={...}</code> は複数書くことができるので、家や職場を指定しておくと便利です。(一つでも問題ありません)</li>
</ul>
<aside class="warning"><p>特に職場の Wi-Fi を利用する際には、ネットワーク管理者の了解を取るようにしてください。また、Wi-Fi 接続時に Web ブラウザ等による認証が必要なネットワークは利用できません。</p>
</aside>
<h3 is-upgraded>ssh</h3>
<pre><code></code></pre>
<p>このファイルは「存在する事」が重要です。ファイルの中身は「空 (=0バイト)」にしてください。</p>
<h2 is-upgraded>2つのファイルを microSD の &#34;boot&#34; にコピーする</h2>
<p>一度取り出した microSD を再度パソコンに取り付けます。boot と表示されたディスクが現れるのを確認してください。</p>
<p>その後、先ほどの 2 ファイルを &#34;boot&#34; にコピーします。</p>
<p class="image-container"><img style="width: 594.00px" src="img/b3c9a091ac92f113.png"></p>
<p>※画面は macOSですが、Windows も同様です。</p>
<p>コピーが完了したら microSD を取り出してください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Raspberry Pi の起動から SSH ログイン、OS の最新化まで" duration="20">
        <h2 is-upgraded>Raspberry Pi の電源 ON</h2>
<h3 is-upgraded>microSD を Raspberry Pi に取り付けます</h3>
<p>少し残りますが奥までしっかりと刺さっていれば問題ありません。</p>
<p class="image-container"><img style="width: 601.70px" src="img/5fc2b4742e508eda.png"></p>
<h3 is-upgraded>有線 LAN で Raspberry Pi とパソコンを接続</h3>
<p>Raspberry Pi の有線 LAN ポートと、パソコンの有線 LAN ポートをケーブルで接続します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/3cb100652a7c023a.png"></p>
<h3 is-upgraded>Raspberry Pi に microUSB (電源ケーブル) を接続</h3>
<p>ケーブルを挿すと、電源 ON となります。（電源スイッチのようなものがありません）</p>
<p class="image-container"><img style="width: 601.70px" src="img/99acea5891fdae4d.png"></p>
<p>しばらく経過(約1~2分)すると macOS もしくは Windows 10 から Raspberry Pi へリモートログイン出来るようになります。</p>
<h2 is-upgraded>SSH リモートログインの方法</h2>
<h3 is-upgraded>Windows の場合</h3>
<p>スタートメニューから「コマンドプロンプト」を起動します。</p>
<p>コマンドプロンプトで以下のように入力して実行します。</p>
<pre>ssh pi@raspberrypi.local</pre>
<ul>
<li><code>Are you sure you want to continue connecting (yes/no)?</code> との問いには yes と入力します。</li>
<li>初期パスワードは <a href="https://www.raspberrypi.org/documentation/linux/usage/users.md" target="_blank">Raspbian のドキュメント</a> に記載されていますので、それを利用してログインしてください。</li>
</ul>
<aside class="warning"><p><strong>Windows 10 で接続ができない場合は？</strong></p>
<p>Windows 10の以前の場合(Windows 10 の最新版でない場合も同様)は、 <a href="https://support.apple.com/ja_JP/downloads/itunes" target="_blank">Windows 用 Apple iTunes をインストール</a>しないと Host not found となり、接続ができない場合があります。 (mDNS(Bonjour) を導入する必要があります)</p>
<p>また、Raspberry Pi の<strong>電源が ON になる前</strong>にパソコンと有線 LAN で接続しないと、SSH リモートログインできない場合があります。</p>
</aside>
<h3 is-upgraded>macOS の場合</h3>
<p>［Finder］&gt;［アプリケーション］&gt;［ユーティリティ］&gt;［ターミナル］を起動します。</p>
<aside class="special"><p>Spotlight (検索) から &#34;Terminal.app&#34; を探して起動する方法もあります。</p>
</aside>
<p>Terminal.app で以下のように入力して実行します。</p>
<pre>ssh pi@raspberrypi.local</pre>
<ul>
<li><code>Are you sure you want to continue connecting (yes/no)?</code> との問いには yes と入力します。</li>
<li>初期パスワードは <a href="https://www.raspberrypi.org/documentation/linux/usage/users.md" target="_blank">Raspbian のドキュメント</a> に記載されていますので、それを利用してログインしてください。</li>
</ul>
<h2 is-upgraded>OS の最新化</h2>
<p>以降は Windows、macOS 共通の作業です。</p>
<p>Raspberry Pi へ SSH リモートログインしたあと、Raspberry Pi 側で以下を1行ずつ実行します。</p>
<pre>sudo timedatectl set-timezone Asia/Tokyo
sudo apt update
sudo apt upgrade -y
sudo systemctl reboot</pre>
<p>最後の1行で再起動となります。</p>
<aside class="special"><p><strong>SSH リモートログイン終了の方法</strong></p>
<p>Raspberry Pi 側で以下を実行します。</p>
<p><code>exit</code></p>
<p>これで終了となります。コマンドプロンプト、もしくは Terminal.app を閉じることができます。</p>
</aside>
<h2 is-upgraded>Raspberry Pi の 電源 を OFF</h2>
<p>OS の最新化を行った後、再起動で Raspberry Pi の起動が確認出来たら、この後行うセンサーの取り付けのために電源を OFF とします。</p>
<p>電源を OFF にする場合は SSH リモートログインした後、Raspberry Pi 側で以下を実行します。</p>
<pre>sudo systemctl poweroff</pre>
<p>この後 1分ほど経過して緑色 LED の点滅が止んだら microUSB ケーブルを抜きます。これで OFF にできます。</p>


      </google-codelab-step>
    
      <google-codelab-step label="超音波距離センサーを取り付ける" duration="0">
        <h2 is-upgraded>パーツを準備する</h2>
<p>以下のパーツを準備してください。</p>
<ul>
<li>ジャンパワイヤ (オス - メス) x 4 ※ 画像上部ケーブル</li>
<li>超音波距離センサー (3.3V対応) x 1 ※画像左下のスピーカのような形の緑色の基板</li>
<li>ブレッドボード x 1 ※画像右下の穴あき板</li>
</ul>
<p class="image-container"><img style="width: 601.70px" src="img/56619254079777f8.png"></p>
<h2 is-upgraded>超音波距離センサーのジャンパプラグを抜き取る</h2>
<p>超音波距離センサーの裏面を確認してください。その時、ジャンパプラグ(白、もしくは黒の部品)がついていれば抜き取ってください。</p>
<p>抜き取ったジャンパプラグは本レシピでは使用しませんが、保管しておいてください。(無くした場合でも別途購入は可能です)</p>
<p class="image-container"><img style="width: 601.70px" src="img/54b600d4c7209d08.png"></p>
<aside class="special"><p><strong>ジャンパプラグの役割</strong></p>
<p>今回利用している超音波距離センサー(US-100)は、計測した距離データを2つの方法(UARTモード、HC-SR04モード)で取得することができます。ジャンパプラグがついている状態はUARTモードです。今回はHC-SR04モードによる動作をさせるため、ジャンパプラグを抜いています。詳しくは<a href="https://www.switch-science.com/catalog/5512/" target="_blank">スイッチサイエンスの商品ページ</a>をご覧ください。</p>
</aside>
<h2 is-upgraded>配線</h2>
<h3 is-upgraded>超音波距離センサーをブレッドボードに刺します。</h3>
<p>端から1列目に挿します。ブレッドボードの向きに気をつけてください。</p>
<p class="image-container"><img style="width: 601.70px" src="img/b096caaaec3a1a75.png"></p>
<aside class="special"><p><strong>ブレッドボードとは？</strong></p>
<p>表面に開いている穴にジャンパワイヤなどを挿すだけで電子回路を組み上げることができる配線用のパーツです。抜き挿しだけで回路の組み換えが可能であるため、試験時に用いられます。内部的には右図のオレンジの線でつながってます。</p>
<p class="image-container"><img style="width: 587.00px" src="img/7ab25c5cff78a729.png"></p>
</aside>
<aside class="special"><p><strong>ブレッドボードを使わずに配線する</strong></p>
<p>冒頭の動画では、ブレッドボードを経由せず超音波距離センサーとRaspberry Piを直接接続する方法をご紹介しています。この場合は別途「メス―メス型のジャンパワイヤ」を4本ご用意ください。接続場所自体は本レシピで紹介している通りです。</p>
</aside>
<h3 is-upgraded>ジャンパーワイヤをブレッドボードに挿します。</h3>
<p>センサーのピンは5つありますが、そのうち右側4つを使用します（一番左のピンは利用しません）ジャンパワイヤはセンサーの一番右から赤、青、黄、黒と挿します。</p>
<p class="image-container"><img style="width: 601.70px" src="img/ac5f2e3e2e4fd6e4.png"></p>
<h3 is-upgraded>ジャンパワイヤをRaspberry Piにつなげる</h3>
<p><strong>Raspberry Pi の電源は OFF の状態で行ってください。</strong></p>
<p>また、接続するピンを間違えると故障の原因になるので、十分気をつけてください。取り付け順序としては、黒、黄、青、赤と、電源である赤を最後にしていただくと比較的安全です。</p>
<p class="image-container"><img style="width: 601.70px" src="img/e10421692856e839.png"></p>
<h2 is-upgraded>動作テストを行う</h2>
<p>全ての接続が確認出来たら、Raspberry Pi の電源を ON にしてから、Raspberry Pi 上で以下を一行ずつ実行します。</p>
<pre>curl -O https://gist.githubusercontent.com/ma2shita/0569ab4717c49349889c9fbe1af25386/raw/bda9390e8792045d3dd73d5db1f800f6dca8de34/sensor_test.py
python2 sensor_test.py</pre>
<aside class="warning"><p><strong><code>ファイルがダウンロードできない場合は？</code></strong></p>
<p><code>curl</code> の後の <code>-O</code> はゼロでは無く大文字のオーです。</p>
</aside>
<p><code>sensor_test.py</code> の実行の様子です。センサの前に手をかざしてみて、距離が変化する事を確認してください。</p>
<pre>pi@raspberrypi:~ $ python2 sensor_test.py
距離: 8.2 cm
距離: 8.3 cm
距離: 8.3 cm
距離: 8.2 cm
距離: 8.2 cm
距離: 12.2 cm
距離: 335.4 cm
距離: 337.5 cm
距離: 335.6 cm</pre>
<p>プログラムの終了は <code>Ctrl + C</code> です。</p>
<aside class="warning"><p><strong>プログラムを実行しても距離が表示されない場合は？</strong></p>
<p>2つの原因が考えられます。1つ目はセンサー前に「何も存在しない」場合です。確認用プログラムでは &#34;距離が500cmと判定された場合には、何も表示しない&#34; としています。そのため、センサー前に手をかざしてみてください。</p>
<p>2つめは配線間違いです。センサーの前に手をかざしてみても動かない場合はこのケースになります。速やかに確認用プログラムを停止したあと、Raspberry Piの電源をOFFにしてから、配線を再度確認してください。</p>
</aside>
<h3 is-upgraded>【参考】<a href="https://gist.github.com/ma2shita/0569ab4717c49349889c9fbe1af25386" target="_blank">sensor_test.py</a></h3>
<pre><code>#!/usr/bin/env python
# -*- coding: utf-8 -*-

import time
# 距離を読む関数
def read_distance():
    # 必要なライブラリのインポート・設定
    import RPi.GPIO as GPIO

    # 使用するピンの設定
    GPIO.setmode(GPIO.BOARD)
    TRIG = 11 # ボード上の11番ピン(GPIO17)
    ECHO = 13 # ボード上の13番ピン(GPIO27)

    # ピンのモードをそれぞれ出力用と入力用に設定
    GPIO.setup(TRIG,GPIO.OUT)
    GPIO.setup(ECHO,GPIO.IN)
    GPIO.output(TRIG, GPIO.LOW)

    # TRIG に短いパルスを送る
    GPIO.output(TRIG, GPIO.HIGH)
    time.sleep(0.00001)
    GPIO.output(TRIG, GPIO.LOW)

    # ECHO ピンがHIGHになるのを待つ
    signaloff = time.time()
    while GPIO.input(ECHO) == GPIO.LOW:
        signaloff = time.time()

    # ECHO ピンがLOWになるのを待つ
    signalon = signaloff
    while time.time() &lt; signaloff + 0.1:
        if GPIO.input(ECHO) == GPIO.LOW:
            signalon = time.time()
            break

    # GPIO を初期化しておく
    GPIO.cleanup()

    # 時刻の差から、物体までの往復の時間を求め、距離を計算する
    timepassed = signalon - signaloff
    distance = timepassed * 17000

    # 500cm 以上の場合はノイズと判断する
    if distance &lt;= 500:
        return distance
    else:
        return None

def main():
    while True:
        distance = read_distance()
        if distance:
            print &#34;距離: %.1f cm&#34; % distance

        time.sleep(1)

if __name__ == &#34;__main__&#34;:
    main()</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="スピーカーを接続する" duration="0">
        <p>スピーカーとオーディオケーブルを準備し、Raspberry Piとスピーカーをつなげます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/fc1d6e7ec7c0d49b.png"></p>
<p>接続が確認出来たら、Raspberry Pi 上で以下を実行します。成功すると「フロント・センター」と英語で再生されます。音量にはご注意ください。また、聞こえない場合はスピーカーの音量を調整してください。</p>
<pre>aplay -D plughw:CARD=0,DEV=0 /usr/share/sounds/alsa/Front_Center.wav</pre>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Air によるインターネット接続" duration="10">
        <p>ここからはUSBドングル型モデム(AK-020)とSORACOM IoT SIMを利用してセルラー通信経由でインターネット接続が行えるようにします。</p>
<h2 is-upgraded>setup_air.sh の実行</h2>
<p>USB ドングル型モデムで SORACOM Air によるインターネット接続の一連の設定を自動化する setup_air.sh を実行します。</p>
<p>以下をRaspberry Piで1行ずつ実行してください。</p>
<pre><code>curl -O https://soracom-files.s3.amazonaws.com/setup_air.sh
sudo bash setup_air.sh</code></pre>
<h2 is-upgraded>USB ドングル型モデム (AK-020) に SIM を取り付け、Raspberry Pi に接続する</h2>
<p>以下の図を参考に取り付けてください。</p>
<p class="image-container"><img style="width: 601.70px" src="img/8c36e7519ddd583e.png"></p>
<p>Raspberry Pi の USB ポートはどこでも構いませんが、この後に接続する USB カメラとの位置で競合しないようにしてください。USB ドングル型モデム、USB カメラ共に Raspberry Pi の電源が ON 状態でもいつでも抜き挿し可能です。</p>
<h2 is-upgraded>接続を確認する</h2>
<p>USB ドングル型モデムの LED を見ながら接続状態になったのを見計らって、以下をRaspberry Piで実行します。</p>
<pre><code>ping -c 4 pong.soracom.io</code></pre>
<p>この時、期待される出力は以下の通りです。</p>
<pre><code>PING pong.soracom.io (100.127.100.127) 56(84) bytes of data.
64 bytes from 100.127.100.127 (100.127.100.127): icmp_seq=1 ttl=64 time=75.6 ms
64 bytes from 100.127.100.127 (100.127.100.127): icmp_seq=2 ttl=64 time=58.8 ms
64 bytes from 100.127.100.127 (100.127.100.127): icmp_seq=3 ttl=64 time=55.4 ms
64 bytes from 100.127.100.127 (100.127.100.127): icmp_seq=4 ttl=64 time=43.4 ms</code></pre>
<p>これで Raspberry Pi から SORACOM Air を通じてインターネット接続が可能になりました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="AWS Lambda で Lambda 関数を作成する" duration="0">
        <p>ここからはAWS LambdaでLambda関数を作成します。</p>
<p><a href="https://console.aws.amazon.com/" target="_blank">AWS マネジメントコンソール</a>を開き、AWS Lambdaの関数作成画面へと進みます。</p>
<p>AWSは数多くのサービスがあるため、トップページで「lambda」と探すと素早く移動できます。</p>
<p class="image-container"><img style="width: 561.00px" src="img/2cbca3feea78d0b8.png"></p>
<p>AWS Lambdaの管理画面で［関数の作成］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/1f43a5b2256a0352.png"></p>
<p>関数の作成画面では［一から作成］をクリックした後、以下のように入力をして［関数の作成］をクリックします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>関数名</p>
</td><td colspan="1" rowspan="1"><p><code>storebot</code></p>
</td><td colspan="1" rowspan="1"><p>任意の名前が利用できます。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ランタイム</p>
</td><td colspan="1" rowspan="1"><p>Python3.8</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/959572ce1c385032.png"></p>
<p>しばらくすると関数の管理画面に移動します。まず［アクセス権限］タブをクリックし、その後 &#34;ロール名&#34; の部分 (図中では <code>storebot-role-...</code> となっている部分)をクリックします。するとAWS IAM(Identity and Access Management)の管理画面に移動します。</p>
<p class="image-container"><img style="width: 508.00px" src="img/384166e5de6c5b14.png"></p>
<p>AWS IAMの管理画面でポリシー名の &#34;AWSLambdaBasic...&#34; から始まるリンクをクリックします。</p>
<p class="image-container"><img style="width: 525.00px" src="img/696b60c82551ed17.png"></p>
<p>続いて表示された画面で［ポリシーの編集］をクリックします。</p>
<p class="image-container"><img style="width: 568.00px" src="img/7414b99a17838062.png"></p>
<p>続いての画面では［さらにアクセス許可を追加する］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/a38bb8a869d6e5e9.png"></p>
<p>次の画面では &#34;サービス&#34; 等を以下のように設定したら［ポリシーの確認］をクリックします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>サービス</p>
</td><td colspan="1" rowspan="1"><p>Polly</p>
</td><td colspan="1" rowspan="1"><p>検索窓に <code>polly</code> と入力すると素早く見つけることができます。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>アクション</p>
</td><td colspan="1" rowspan="1"><p>SynthesizeSpeedh</p>
</td><td colspan="1" rowspan="1"><p>検索窓に <code>synthe</code> と入力すると素早く見つけることができます。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>リソース</p>
</td><td colspan="1" rowspan="1"><p>全てのリソース</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>リクエスト条件</p>
</td><td colspan="1" rowspan="1"><p>（設定不要）</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/71291355a704a5e6.png"></p>
<p>確認画面では［変更の保存］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/541a2f53228f4deb.png"></p>
<p>ここまでの作業が終了したら、AWS IAMの画面は閉じて問題ありません。<br>続いてはAWS Lambdaの管理画面に戻り、［設定］タブをクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/b96eb31f278b6c0a.png"></p>
<p>下にスクロールすると &#34;関数コード&#34; が出てきます。この中のプログラムを後述する &#34;storebot (Lambda 関数)&#34; の内容と入れ替えます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/5767a82c6934fc1c.png"></p>
<h3 is-upgraded>storebot (Lambda 関数)</h3>
<pre><code>from boto3 import Session
from boto3 import resource
from contextlib import closing
import base64

def lambda_handler(event, context):
    text = &#34;こんにちは、このメッセージは店番ロボット君です。お店の前に立ち止まった人に展示物を解説します。実際はテキストを動的に作ったり、Amazon Sスリーを経由して受け渡すのが良いでしょう。&#34;

    polly = Session().client(&#34;polly&#34;)
    response = polly.synthesize_speech(Text=text, OutputFormat=&#34;mp3&#34;, VoiceId=&#34;Mizuki&#34;)
    with closing(response[&#34;AudioStream&#34;]) as stream:
        r = {&#39;encode&#39;: &#39;base64&#39;, &#39;format&#39;: &#34;mp3&#34;, &#39;data&#39;: base64.b64encode(stream.read()).decode(&#39;utf-8&#39;)}
        return r</code></pre>
<p>入れ替えたら、AWS Lambda 管理画面上部の［テストイベントの選択］をクリックし、その後［テストイベントの設定］をクリックします。</p>
<p class="image-container"><img style="width: 278.50px" src="img/887fa66f5c29b3f4.png"></p>
<p>ダイアログでは以下のように設定した後、［作成］をクリックします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>イベント名</p>
</td><td colspan="1" rowspan="1"><p><code>test</code></p>
</td><td colspan="1" rowspan="1"><p>名前は任意です。</p>
</td></tr>
</table>
<p>※イベントの中身自体は変更しません。</p>
<p class="image-container"><img style="width: 601.70px" src="img/e409b281ad8caed.png"></p>
<p>AWS Lambdaの管理画面で［保存］をクリックした後に［テスト］をクリックします。</p>
<p class="image-container"><img style="width: 420.00px" src="img/cb0d96febbc58649.png"></p>
<p>テスト実行後に &#34;関数コード&#34; で <strong>&#34;Status: Succeeded&#34;</strong> となっていれば成功です。</p>
<p class="image-container"><img style="width: 601.70px" src="img/5f70496b288b5698.png"></p>
<aside class="warning"><p><strong>Succeededにならない場合は？</strong></p>
<p>主に2つの原因が考えられます。</p>
<p>1つ目はAWS IAM設定です。今回は Amazon Pollyというサービスに音声データを作成させています。その時の権限が SynthesizeSpeedh です。Lambda 関数にこの権限が割り当てられていないとAmazon Pollyは動作拒否をします。AWS IAMの設定まで戻って確認してください。</p>
<p>2つ目はプログラムの入れ替えミスです。既存のプログラムが残っていたりすると失敗します。再度入れ替えをしてみてください。</p>
</aside>
<p>&#34;関数コード&#34; の［Deploy］をクリックします。ボタンが白くなったら完了です。</p>
<p class="image-container"><img style="width: 357.00px" src="img/4019d3f8bdaad2c6.png"></p>
<h3 is-upgraded>ARNを入手する</h3>
<p>ここまでの動作が確認出来たら、最後にLambda 関数の ARN(Amazon Resource Name) を入手します。このARNは後ほど SORACOM Funk で使用するため必ず入手してください。<br>Lambda 関数管理画面の上部にある ARN をメモしてください。(書類マークでコピーできます)</p>
<p class="image-container"><img style="width: 601.70px" src="img/84582b0c5f9f93ce.png"></p>
<p>以上で AWS Lambda の設定は終了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="AWS IAM で SORACOM Funk 用の認証情報を作成する" duration="0">
        <p>SORACOM Funk から先ほど作成した Lambda 関数を呼び出せるように、専用の認証情報をAWSで作成します。</p>
<p>AWS マネジメントコンソールを開き、AWS IAM管理画面へと進みます。</p>
<p>AWSは数多くのサービスがあるため、トップページで「iam」と探すと素早く移動できます。</p>
<p class="image-container"><img style="width: 493.00px" src="img/937c18e5f8eb0b67.png"></p>
<p>AWS IAM管理画面で［ユーザー］をクリックした後、［ユーザーを追加］をクリックします。<br>※すでに &#34;ユーザー&#34; 画面であれば ［ユーザーを追加］のクリックのみとなります。</p>
<p class="image-container"><img style="width: 512.00px" src="img/6ec1ce28373b28fa.png"></p>
<p>ユーザーを追加の画面では以下のように設定してから［次のステップ：アクセス権限］をクリックします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>ユーザー名</p>
</td><td colspan="1" rowspan="1"><p><code>storebot-invoker-by-soracom</code></p>
</td><td colspan="1" rowspan="1"><p>ユーザー名は任意です。後で見返したときにわかりやすい名前が良いでしょう。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>プログラムによるアクセス</p>
</td><td colspan="1" rowspan="1"><p>チェックを付ける</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/f83dd455c6baed39.png"></p>
<p>アクセス許可の設定画面では［既存のポリシーを直接アタッチ］をクリックした後、 &#34;AWSLambdaRole&#34; にチェックを付け、［次のステップ：タグ］をクリックします。<br>※数が多いためフィルタに <code>lambdarole</code> と入力すると素早く見つけることができるでしょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/281481d0fde25231.png"></p>
<p>タグの追加画面では特に作業はありません。［次のステップ：確認］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/264a083af9a920e1.png"></p>
<p>確認画面で今までの内容をチェックします。特にアクセス権限に AWSLambdaRole が設定されていることを確認してください。その後［ユーザーの作成］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/4c0d7ee016b3da6f.png"></p>
<p>ユーザーの作成直後に表示される &#34;アクセスキー ID&#34; と &#34;シークレットアクセスキー&#34; をメモしておいてください。シークレットアクセスキー［表示］をクリックすると現れます。また、これ以降で確認することが出来ないため、確実にメモしておきましょう。(.csv のダウンロードも良い選択です)</p>
<p class="image-container"><img style="width: 601.70px" src="img/761c8b7ea945041c.png"></p>
<p>以上で AWS IAM の設定は終了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Funk を設定する" duration="0">
        <p>これまで設定してきた情報を使い SORACOM Funk を設定して Lambda 関数を呼び出せるようにします。</p>
<p><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>にログインした後［Menu］&gt;［SIM 管理］とクリックして SIM 管理画面を開きます。</p>
<p class="image-container"><img style="width: 566.00px" src="img/c4968675c5a9a1c8.png"></p>
<aside class="warning"><p><strong>［SIM 管理］をクリックしても画面が切り替わらない場合は？</strong></p>
<p>すでに SIM 管理画面を開いている場合は、［SIM 管理］をクリックしても画面が切り替わることがありません。その場合、青の点線で囲まれている「SORACOM ロゴ」をクリックすることでメニューを閉じることができます。</p>
</aside>
<p>USB ドングル型モデムに取り付けた SIM にチェックを付け、［操作］&gt;［所属グループ変更］とクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/cf061a031b3ce475.png"></p>
<aside class="special"><p><strong>SORACOM の便利な使い方: 複数の SIM を同時に扱う</strong></p>
<p>チェックをつける対象を複数にすれば、一度の複数の SIM を対象に操作が可能です。</p>
</aside>
<p>「新しい所属グループ」のプルダウンボックスをクリックした後、［新しいグループを作成...］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/eca14a331c8696cf.png"></p>
<h2 is-upgraded>「グループ作成」のグループ名を入力して［グループ作成］をクリックします。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>例</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>グループ名</p>
</td><td colspan="1" rowspan="1"><p><code>storebot</code></p>
</td><td colspan="1" rowspan="1"><p>自由に入力可能です。日本語も設定可能です。</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 385.00px" src="img/728b1173e6846db5.png"></p>
<p>新しい所属グループが先ほど作成したグループになっていることを確認したら［グループ変更］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/ead479c0dad57fc3.png"></p>
<p>自動的に SIM 管理画面に戻ります。<br>SIM の「グループ」に先ほど作ったグループが設定されていることを確認してください。</p>
<p class="image-container"><img style="width: 601.70px" src="img/e8be8e0b5d24ac69.png"></p>
<p>以上で、グループの作成と所属の作業は完了です。</p>
<h2 is-upgraded>SORACOM Funk の設定</h2>
<p>先ほど作成したグループをクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/db1d12adc3982609.png"></p>
<p>グループの設定画面で &#34;SORACOM Funk&#34; を探し、クリックします。すると SORACOM Funk の設定画面が開きます。</p>
<p>SORACOM Funk の設定では、まず &#34;OFF&#34; となっている部分をクリックします。すると &#34;ON&#34; に切り替わり、設定ができるようになります。</p>
<p>その後 &#34;サービス&#34; と &#34;送信データ形式&#34; は変更せずに、 &#34;認証情報&#34; の［認証情報を指定しない］をクリックします。表示される一覧の中から［認証情報を新規作成する...］をクリックします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/957445f278bd3118.png"></p>
<p>認証情報を登録する画面では以下の通りに設定した後、［登録］をクリックします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>認証情報 ID</p>
</td><td colspan="1" rowspan="1"><p><code>storebot-invoker</code></p>
</td><td colspan="1" rowspan="1"><p>任意です。後で見返した時にわかりやすくしておくと良いでしょう。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>AWS Access Key ID</p>
</td><td colspan="1" rowspan="1"><p>AWS IAMで設定した時にメモをした「アクセスキー ID」を入力します</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>AWS Secret Access Key</p>
</td><td colspan="1" rowspan="1"><p>AWS IAMで設定した時にメモをした「シークレットアクセスキー」を入力します</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/b29f062e5d3b6639.png"></p>
<p>SORACOM Funk 設定画面に戻ってきたら追加で以下の設定を行い、その後［保存］をクリックします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p>関数の ARN</p>
</td><td colspan="1" rowspan="1"><p>AWS Lambda管理画面でメモをした ARN を入力します。</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/3ca1aa081e00a556.png"></p>
<h2 is-upgraded>SORACOM Funk と AWS Lambda の連携設定をテストする</h2>
<p>ここまでの設定を実際に動作させてみてテストします。</p>
<p>以下をRaspberry Piで1行ずつ実行してください。</p>
<pre>sudo install mpg123
curl -O https://gist.githubusercontent.com/ma2shita/a7f2a0acf9b1a7f43c360e1371aadaed/raw/b07e0ad0b386177eb22ad9734a0f2c1a12c1bb15/soracom_funk_test.py
python2 soracom_funk_test.py</pre>
<aside class="warning"><p><strong><code>ファイルがダウンロードできない場合は？</code></strong></p>
<p><code>curl</code> の後の <code>-O</code> はゼロでは無く大文字のオーです。</p>
</aside>
<p>以下は <code>soracom_funk_test.py</code> の実行の様子です。スピーカーから「こんにちは、このメッセージは店番ロボット君です....」と再生されるでしょう。</p>
<pre>pi@raspberrypi:~ $ python2 soracom_funk_test.py
200
High Performance MPEG 1.0/2.0/2.5 Audio Player for Layers 1, 2 and 3
        version 1.25.10; written and copyright by Michael Hipp and others
        free software (LGPL) without any warranty but with best wishes

Playing MPEG stream 1 of 1: - ...

MPEG 2.0 L III cbr48 22050 mono


[0:15] Decoding of - finished.</pre>
<h3 is-upgraded><a href="https://gist.github.com/ma2shita/a7f2a0acf9b1a7f43c360e1371aadaed" target="_blank">【参考】soracom_funk_test.py</a></h3>
<pre><code>#!/usr/bin/env python
# -*- coding: utf-8 -*-

import urllib2
import json
import base64
from subprocess import Popen, PIPE
def main():
    headers = {&#39;Content-Type&#39;: &#39;application/json&#39;}
    payload = json.dumps({})
    response = urllib2.urlopen(urllib2.Request(&#39;http://uni.soracom.io&#39;, payload, headers))
    print(response.getcode())
    body = json.loads(response.read())
    mp3data = base64.b64decode(body[&#39;data&#39;])
    cp = Popen([&#39;mpg123&#39;, &#39;-&#39;], stdin=PIPE)
    cp.communicate(input=mp3data)

if __name__ == &#34;__main__&#34;:
    main()</code></pre>
<p>これで全ての設定が完了しました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="センサーと組み合わせて動かす" duration="0">
        <p>超音波距離センサーと組み合わせてしゃべることができるか確認します。</p>
<p>以下をRaspberry Piで1行ずつ実行してください。</p>
<pre>curl -O https://gist.githubusercontent.com/ma2shita/e7f5d72c7592e8eb09adf92dcdf4310c/raw/2cd2a5eeb7af3ac144671c8bf5e967438c683e3e/storebot.py
python2 storebot.py</pre>
<aside class="warning"><p><strong><code>ファイルがダウンロードできない場合は？</code></strong></p>
<p><code>curl</code> の後の <code>-O</code> はゼロでは無く大文字のオーです。</p>
</aside>
<p>以下は <code>storebot.py</code> の実行の様子です。超音波距離センサーに手をかざしてみて、5秒経過すると音声が再生されます。</p>
<pre>pi@raspberrypi:~ $ python2 storebot.py
距離: 336.2 cm
0
距離: 336.6 cm
0
距離: 334.9 cm
0
距離: 19.6 cm
0
距離: 20.6 cm
1
距離: 20.5 cm
2
距離: 20.6 cm
3
距離: 20.5 cm
4
距離: 20.6 cm
200
High Performance MPEG 1.0/2.0/2.5 Audio Player for Layers 1, 2 and 3
        version 1.25.10; written and copyright by Michael Hipp and others
        free software (LGPL) without any warranty but with best wishes

Playing MPEG stream 1 of 1: - ...

MPEG 2.0 L III cbr48 22050 mono


[0:15] Decoding of - finished.
0
距離: 335.4 cm
0
距離: 335.9 cm
0
距離: 335.7 cm</pre>
<h3 is-upgraded><a href="https://gist.github.com/ma2shita/e7f5d72c7592e8eb09adf92dcdf4310c" target="_blank">【参考】storebot.py</a></h3>
<pre><code>#!/usr/bin/env python
# -*- coding: utf-8 -*-

MIN_DISTANCE_CM = 20
MAX_DISTANCE_CM = 100
STAY_COUNT = 5

import time
# 距離を読む関数
def read_distance():
    # 必要なライブラリのインポート・設定
    import RPi.GPIO as GPIO

    # 使用するピンの設定
    GPIO.setmode(GPIO.BOARD)
    TRIG = 11 # ボード上の11番ピン(GPIO17)
    ECHO = 13 # ボード上の13番ピン(GPIO27)

    # ピンのモードをそれぞれ出力用と入力用に設定
    GPIO.setup(TRIG,GPIO.OUT)
    GPIO.setup(ECHO,GPIO.IN)
    GPIO.output(TRIG, GPIO.LOW)

    # TRIG に短いパルスを送る
    GPIO.output(TRIG, GPIO.HIGH)
    time.sleep(0.00001)
    GPIO.output(TRIG, GPIO.LOW)

    # ECHO ピンがHIGHになるのを待つ
    signaloff = time.time()
    while GPIO.input(ECHO) == GPIO.LOW:
        signaloff = time.time()

    # ECHO ピンがLOWになるのを待つ
    signalon = signaloff
    while time.time() &lt; signaloff + 0.1:
        if GPIO.input(ECHO) == GPIO.LOW:
            signalon = time.time()
            break

    # GPIO を初期化しておく
    GPIO.cleanup()

    # 時刻の差から、物体までの往復の時間を求め、距離を計算する
    timepassed = signalon - signaloff
    distance = timepassed * 17000

    # 500cm 以上の場合はノイズと判断する
    if distance &lt;= 500:
        return distance
    else:
        return None

import urllib2
import json
import base64
from subprocess import Popen, PIPE
def main():
    cnt = 0
    while True:
        distance = read_distance()
        if distance:
            print &#34;距離: %.1f cm&#34; % distance
    
        if MIN_DISTANCE_CM &lt;= distance and distance &lt;= MAX_DISTANCE_CM:
            cnt += 1
        else:
            cnt = 0
    
        if cnt &gt; STAY_COUNT - 1:
            cnt = 0
            headers = {&#39;Content-Type&#39;: &#39;application/json&#39;}
            payload = json.dumps({})
            response = urllib2.urlopen(urllib2.Request(&#39;http://uni.soracom.io&#39;, payload, headers))
            print(response.getcode())
            body = json.loads(response.read())
            mp3data = base64.b64decode(body[&#39;data&#39;])
            cp = Popen([&#39;mpg123&#39;, &#39;-&#39;], stdin=PIPE)
            cp.communicate(input=mp3data)

        print(cnt)
        time.sleep(1)

if __name__ == &#34;__main__&#34;:
    main()</code></pre>
<p>これで全て動作は完了です。</p>
<h3 is-upgraded>設置をする加工</h3>
<p>例えばですが、スマートフォンスタンドを利用して超音波距離センサーを立てかけるようにできると、立ち止まった人の検知がより確実にできるでしょう。</p>
<p>※この例ではブレッドボードを利用せず、直接Raspberry Piとセンサーを接続しています。</p>
<p class="image-container"><img style="width: 600.00px" src="img/63795cc8e32f1961.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="「電源 ON 時にスタートする」設定を行う" duration="0">
        <p>現在の状態では、Raspberry Piに電源がONになった後、storebot.py を手で起動する必要があります。実際の運用に向けて「電源がONになったら自動的に storebot.py が動き出す」ようにしてみます。</p>
<p>以下をRaspberry Piで1行ずつ実行してください。</p>
<pre>curl -O https://gist.githubusercontent.com/ma2shita/4dfe0f4da1ecec963190be6e8e474990/raw/a9d640ae1797eb642bc96e23cc47340a0c983f97/storebot.service
sudo loginctl enable-linger $USER
systemctl --user enable $PWD/storebot.service
systemctl --user start storebot.service
journalctl -n 10</pre>
<aside class="warning"><p><strong>ファイルがダウンロードできない場合は？</strong></p>
<p><code>curl</code> の後の <code>-O</code> はゼロでは無く大文字のオーです。</p>
</aside>
<p>最後の journalctl で期待される出力は以下の通りです。</p>
<pre><code>Aug 31 04:56:50 raspberrypi systemd[575]: Started Storebot.py auto start.
Aug 31 04:56:50 raspberrypi python2[5269]: 0
Aug 31 04:56:51 raspberrypi python2[5269]: 距離: 338.2 cm
Aug 31 04:56:51 raspberrypi python2[5269]: 0
Aug 31 04:56:52 raspberrypi python2[5269]: 距離: 337.0 cm
Aug 31 04:56:52 raspberrypi python2[5269]: 0
Aug 31 04:56:54 raspberrypi python2[5269]: 距離: 337.8 cm
Aug 31 04:56:54 raspberrypi python2[5269]: 0</code></pre>
<p>これで次回以降、電源ON時に自動的にstorebot.pyが動くようになりました。</p>
<aside class="special"><p><strong>自動起動の仕組み</strong></p>
<p>自動起動は systemd という Linux (Raspberry Pi OS)に標準搭載されているミドルウェアを利用して実現しています。 systemctl コマンドで制御しています。journalctl コマンドでログを確認できます。</p>
</aside>
<aside class="warning"><p><strong>起動前の注意点</strong></p>
<p>起動前にセンサーやUSBドングル型モデム、スピーカー全てが接続されている状態にして、それから起動するようにしてください。</p>
</aside>
<aside class="special"><p><strong>WiFi が無くても動作します</strong></p>
<p>USBドングル型モデムが接続されていれば、IoTデータ通信サービス「SORACOM Air」でインターネット接続ができるため、WiFiが無くとも動作します。</p>
<p>Raspberry Piへのアクセスをしたい場合は本レシピでも紹介した有線LANを利用する方法の他、オンデマンドリモートアクセスサービス「<a href="https://soracom.jp/services/napter/" target="_blank">SORACOM Napter</a>」を利用すればSORACOM Airを通じてクラウド側からアクセスも可能です。SORACOM Napterによるリモートアクセスの詳細は<a href="https://dev.soracom.io/jp/start/napter_ssh/" target="_blank">SORACOM Napter を利用してIoTデバイスにSSHログインする</a>をご覧ください。</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="あとかたづけと注意事項" duration="1">
        <p>本レシピでは費用がかかるサービスを利用しています。<br>本項をよく読み、必要な操作や解除作業を行うようにして、想定外の費用が掛からないようにしてください。</p>
<h2 is-upgraded>費用について</h2>
<p>ここで記載している金額は全て税別、送料別となります。</p>
<h3 is-upgraded>SORACOM プラットフォームの利用料金</h3>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>サービス／機能</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>料金</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/services/air/cellular/price_specific_area_sim/" target="_blank">SORACOM Air (plan-D)</a></p>
</td><td colspan="1" rowspan="1"><ul>
<li>基本料: 10円/日</li>
<li>通信料: 0.2円~/MB</li>
</ul>
<p>(今回の利用であれば 100MB 以内で収まる範囲)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/services/funk/price/" target="_blank">SORACOM Funk</a></p>
</td><td colspan="1" rowspan="1"><ul>
<li>50000リクエスト/月を超えた分は0.0018円/リクエスト</li>
</ul>
</td></tr>
</table>
<p>※ 費用詳細はリンク先をご確認ください。</p>
<aside class="special"><p><strong>無料利用枠について</strong></p>
<p>SORACOM サービスでは一部サービスにおいて無料枠が設定されています。たとえば SORACOM Air for セルラーであればアカウント毎で30円/月の通信分などです。料金詳細に「無料利用枠」として掲載されていますので、ご確認ください。</p>
</aside>
<h2 is-upgraded>グループ解除</h2>
<p>SORACOM Funk はリクエスト回数に応じて費用が発生する従量課金サービスです。そのため、通信が発生しなければ費用も発生しませんが、「機能を OFF にする」することで確実に費用の発生を抑えることができます。またもう1つの方法として「グループからSIMのの所属を解除する」事でも同様の効果が得られます。</p>
<p>グループ解除や削除の方法は<a href="https://soracom.github.io/iot-recipes/unjoin-from-group/" target="_blank">グループからの解除 (JP)</a>をご覧ください。</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://soracom.github.io/iot-recipes/codelab-elements/native-shim.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/custom-elements.min.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/prettify.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/codelab-elements.js"></script>

</body>
</html>
