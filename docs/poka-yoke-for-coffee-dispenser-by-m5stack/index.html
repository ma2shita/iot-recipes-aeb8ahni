
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>【IoT DIY レシピ】M5Stack と 3G拡張ボードで作る「コーヒーカップ取り忘れお知らせデバイス」</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://soracom.github.io/iot-recipes/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-66865146-33"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="poka-yoke-for-coffee-dispenser-by-m5stack"
                  title="【IoT DIY レシピ】M5Stack と 3G拡張ボードで作る「コーヒーカップ取り忘れお知らせデバイス」"
                  environment="web"
                  feedback-link="https://soracom.jp/products/kit/3g_module_m5stack_set/">
    
      <google-codelab-step label="M5Stack と 3G 拡張ボードで作る「コーヒーカップ取り忘れお知らせデバイス」" duration="1">
        <p>レシピ難易度：★★☆☆☆</p>
<p>LCD付きプロトタイピング向けマイコンキット &#34;M5Stack&#34; にモバイルデータ通信機能を加える &#34;3G 拡張モジュール&#34; を組み合わせて、コーヒーマシンに置き忘れたカップをメールでお知らせしてくれるデバイスを作ります。</p>
<p class="image-container"><img style="width: 520.00px" src="img/44b4c08b8ca1d9ad.gif"></p>
<p class="image-container"><img style="width: 602.00px" src="img/ce8cb96d90703c0.png"></p>
<h2 is-upgraded>全体の構成</h2>
<p class="image-container"><img style="width: 602.00px" src="img/343c851889e83627.png"></p>
<h3 is-upgraded>使用する SORACOM サービス</h3>
<ul>
<li>データ通信サービス <a href="https://soracom.jp/services/air/" target="_blank">SORACOM Air</a></li>
<li>データ収集・蓄積サービス <a href="https://soracom.jp/services/harvest/" target="_blank">SORACOM Harvest Data</a></li>
<li>クラウドファンクションサービス <a href="https://soracom.jp/services/funk/" target="_blank">SORACOM Funk</a></li>
</ul>
<h2 is-upgraded>本レシピを行うのに必要な時間、概算費用</h2>
<p>本レシピは以下の通りです。</p>
<ul>
<li>必要な時間: 約1時間30分</li>
<li>概算費用: 約15,500円</li>
</ul>
<p>※ 概算費用: ハードウェアや SORACOM を始めとした各種サービスの概ねの費用 (税や送料などの付帯費用や無料枠適用は考慮しないものとしています)</p>
<h2 is-upgraded>このコンテンツの進め方</h2>
<p>ページの内容を読み、また作業を行ったら右下の［Next］を押して次のステップへ進みます。また、［Back］を使って戻ったり、左のナビゲーションメニューでもページの移動が可能です。</p>
<p>左上の［×］を押してコンテンツを終了することができます。また、ページを開きなおすことで再開できます。ページのアドレスはブラウザの［履歴］メニューを利用してください。</p>

<aside class="warning"><p>本コンテンツは現状のままで提供され、株式会社ソラコムは、誤りがないことの保証を含め、明示であると黙示であるとを問わず、本コンテンツの記載内容につき、いかなる種類の表明も保証も行いません。</p>
<p>掲載情報の閲覧及び利用により、利用者自身、もしくは第三者が被った損害に対して、直接的、間接的を問わず、株式会社ソラコムは責任を負いかねます。</p>
<p>本コンテンツを実践する中で用意された機器、利用されたサービスについてのご質問は、それぞれの機器やサービスの提供元にお問い合わせをお願いします。機器やサービスの仕様は、本コンテンツ作成当時のものです。</p>
<p>株式会社ソラコムが提供する機器・サービスについてのご質問は、 <a href="https://soracom.jp/contact/" target="_blank">https://soracom.jp/contact/</a> をご確認の上、適切な窓口へのお問い合わせをお願いします。機器・サービスご利用前の導入相談は <a href="https://soracom.jp/contact/contactsales/" target="_blank">https://soracom.jp/contact/contactsales/</a> に、機器・サービスご利用開始後のサポートは、SORACOMユーザーコンソール内の<a href="https://soracom.zendesk.com/hc/ja/requests/" target="_blank">サポートサイトから「リクエストを送信」</a>(要ログイン)にてお問い合わせください。</p>
<p>本ドキュメントは <a href="https://github.com/googlecodelabs/tools" target="_blank">CLaaT</a> を用いて制作しています</p>
<p>Copyright (c) 2020 SORACOM, INC.</p>
</aside>



      </google-codelab-step>
    
      <google-codelab-step label="準備" duration="1">
        <p>本レシピを行うためには以下のものをご用意ください。</p>
<h2 is-upgraded>ハードウェア</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>品名</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>数量</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>価格</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>購入先</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>M5Stack Basic 3G 拡張ボード セット</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>12,800円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/products/kit/3g_module_m5stack_set/" target="_blank">ソラコム</a></p>
</td><td colspan="1" rowspan="1"><p>M5Stack と <a href="https://soracom.jp/products/kit/3g_module_m5stack/" target="_blank">M5Stack 用 3G 拡張ボード</a>をそれぞれ準備いただいてもレシピを進めることができます。</p>
<p>M5Stack 用 3G 拡張ボードが対応している M5Stack は <a href="https://www.switch-science.com/catalog/3647/" target="_blank">Basic</a> と <a href="https://www.switch-science.com/catalog/3648/" target="_blank">Gray</a> の2モデルです。M5Stack FIRE は非対応ですのでご注意ください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SORACOM 特定地域向け IoT SIM (plan-D / データ通信のみ / nanoSIM サイズ)</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>852円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/products/sim/plan-d/" target="_blank">ソラコム</a></p>
<p><a href="https://www.amazon.co.jp/dp/B07WMQ49W3/" target="_blank">Amazon.co.jp</a></p>
</td><td colspan="1" rowspan="1"><p>サイズは nano をお求めください。「マルチカット」には nano サイズが含まれています。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>対辺1.5mm 六角レンチ(ドライバー)</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約410円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://www.amazon.co.jp/dp/B00B4TCYIW/" target="_blank">Amazon.co.jp</a></p>
</td><td colspan="1" rowspan="1"><p>M5Stack 用 3G 拡張ボードへ SIM を挿す際にボードの取り付け・取り外しに使用します。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>M5Stack用ToF測距センサユニット</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約1,430円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://www.switch-science.com/catalog/5219/" target="_blank">スイッチサイエンス</a></p>
</td><td colspan="1" rowspan="1"><p>光を利用した距離センサーです。取り付け用の Grove ケーブルが1本添付されています。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>開発用パソコン</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>Arduino IDE と M5Stack 開発環境が整っていること。</p>
<p>セットアップ方法は <a href="https://soracom.github.io/iot-recipes/setup-for-m5stack-with-arduino-ide/" target="_blank">【SORACOM ハンズオン】M5Stack 開発環境セットアップ (Windows / macOS 共通) (全体で約90分)</a> をご覧ください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>(必要な方のみ)</p>
<p>USB 変換アダプタ</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>パソコンに USB Type-A ポートがない場合に準備してください。</p>
<p>1A 以上の電力が供給できるものを利用してください。(USB 3.0以上に対応していれば概ね安心です)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>(必要な方のみ)</p>
<p>USB Type-C ↔ Type-C ケーブル</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>パソコンに USB Type-A ポートが用意できず、また、USB 変換アダプタも用意できない場合に準備してください。</p>
</td></tr>
</table>
<p>※ 金額はレシピ作成時となります。ソラコムで販売している金額は税抜き・送料別です。その他は参考価格となります。</p>
<h2 is-upgraded>その他必要なもの</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>必要なもの</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>費用</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>作成方法など</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SORACOM アカウント</p>
</td><td colspan="1" rowspan="1"><p>無料※</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.github.io/iot-recipes/create-account-soracom-jp/" target="_blank">SORACOM アカウントの作成 (JP)</a></p>
</td></tr>
</table>
<p>※ アカウント作成・維持の費用の料金です。</p>
<h2 is-upgraded>設置に利用したもの</h2>
<p>本レシピで設置時に利用した部材です。必須ではありませんがご参考にお使いください。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>品名</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>数量</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>コーヒーマシン</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>今回は<a href="https://nestle.jp/brand/nba/lineup/i/" target="_blank">ネスカフェ ゴールドブレンド</a></p>
<p><a href="https://nestle.jp/brand/nba/lineup/i/" target="_blank">バリスタ i[アイ]</a>を利用しました。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>USB 型 AC アダプタ</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>M5Stack への電源供給用です。1A以上供給できるものが望ましいでしょう。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>USB Type-C ケーブル</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>M5Stack への電源供給用です。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>両面テープ</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>ToF 距離センサーの固定用です。</p>
</td></tr>
</table>


      </google-codelab-step>
    
      <google-codelab-step label="M5Stack 用 3G 拡張ボードに SIM を取り付ける" duration="15">
        <p>M5Stack 用 3G 拡張ボード(以下、3G拡張ボード)には SIM スロットが備わっており、ここに SIM を入れることで 3G 通信が可能となります。 SIM の取り付け・取り外しは 3G拡張ボードをケースから取り外す必要があります。</p>
<h2 is-upgraded>3G拡張ボードをケースから取り外す</h2>
<p>3G拡張ボードの四隅にあるネジを取り外します。ネジは紛失しないようにしてください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/55460decc2ab9d1f.png"></p>
<h2 is-upgraded>SIM を取り付ける（取り外し方法含む）</h2>
<p>SIM のサイズは nano です。取り付けはSIMをスロットに挿入したら「カチッ」と音が鳴るまで押し込みます。音が鳴ったら完了です。取り外しはSIMを奥まで押し込み「カチッ」と音が鳴ればSIMが出てきますので取り外しできます。</p>
<p class="image-container"><img style="width: 426.00px" src="img/f50325f437657f30.gif"></p>
<h2 is-upgraded>3G拡張ボードをケースに取り付ける</h2>
<p>再度3G拡張ボードをケースに取り付けます。取り付け向きはピンが外側 (ケースから飛び出るように) します。逆向き (ピンがケースの内側を向いてしまっている) には取り付け内でください。</p>
<p>最後はネジで固定します。</p>
<p class="image-container"><img style="width: 602.00px" src="img/6231353265f3e4e3.png"></p>
<aside class="special"><p><strong>M5Stack ボードの取り付け向き</strong></p>
<p>M5Stack は正方形であるためボードとケースの取り付け方角がわかりづらいのですが、ボード上のピン(M5-BUS と呼ばれる)の辺と、ケース側面の切れ込みの辺を合わせるようです。</p>
</aside>
<h2 is-upgraded>重ねる</h2>
<p>取り付け終わったら一番下から「BOTTOM」「3G拡張ボード」「Core※」と重ねていきます。</p>
<p>※ Core = M5Stack の LCD(モニター)やボタンがついているモジュール</p>
<p>以上で3G 拡張ボードへの SIM 取り付け作業は完了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Air を利用してセルラー通信をしてみる" duration="15">
        <p>3G 拡張ボードを使って SORACOM Air によるセルラー通信を行い、3G 拡張ボードの動作確認を行います。</p>
<h2 is-upgraded>セルラー通信ライブラリのインストール</h2>
<p>3G 拡張ボードで利用できる通信ライブラリをインストールします。今回は <a href="https://github.com/vshymanskyy/TinyGSM" target="_blank">TinyGSM</a> というオープンソースライブラリを利用して、世界時計を M5Stack で表示してみます。</p>
<h3 is-upgraded>［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;TinyGSM&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>TinyGSM </strong>(by Volodymyr Shymanskyy) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/681ffa7927b99280.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;TinyGSM&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>tinygsm</code> と入力すると素早く見つけることができます。</p>
<p class="image-container"><img style="width: 587.00px" src="img/57e36a8bda8fcd71.png"></p>
</aside>
<h2 is-upgraded>World Time API を取得して表示するスケッチ</h2>
<p>動作テストを兼ねて世界時計を API で提供している <a href="http://worldtimeapi.org" target="_blank">World Time API</a> から日時を取得して表示します。 </p>
<aside class="special"><p><strong>ブラウザで試してみるには？</strong></p>
<p>World Time API を始めとした、いわゆる Web API はブラウザでも実行できることがあります。今回の World Time API であればブラウザで <a href="http://worldtimeapi.org/api/timezone/Asia/Tokyo.txt" target="_blank"><code>http://worldtimeapi.org/api/timezone/Asia/Tokyo.txt</code></a> を開いてみると、API で取得できる値をブラウザで表示できます。</p>
</aside>
<p>Arduino IDE を起動し［ファイル］&gt;［新規ファイル］を開くと <code>void setup() {</code> から始まる「空のスケッチ」が表示されます。</p>
<p>一度スケッチの内容を削除してから、後述のスケッチで置き換えてください。</p>
<p class="image-container"><img style="width: 849.70px" src="img/22e611963f846c4f.png"></p>
<h3 is-upgraded><a href="https://gist.github.com/ma2shita/abba497ebc2a4d93ca4b3e3bda2bb2fc" target="_blank">m5stack_3gextboard_worldclock.ino</a></h3>
<pre><code>/*
 * Copyright (c) 2019 Kohei &#34;Max&#34; MATSUSHITA
 * Released under the MIT license
 * https://opensource.org/licenses/mit-license.php
*/
#include &lt;M5Stack.h&gt;

#define TINY_GSM_MODEM_UBLOX
#include &lt;TinyGsmClient.h&gt;

TinyGsm modem(Serial2); /* 3G board modem */
TinyGsmClient ctx(modem);

void setup() {
  Serial.begin(115200);
  M5.begin();
  M5.Lcd.clear(BLACK);
  M5.Lcd.setTextColor(WHITE);
  M5.Lcd.println(F(&#34;M5Stack + 3G Module&#34;));

  M5.Lcd.print(F(&#34;modem.restart()&#34;));
  Serial2.begin(115200, SERIAL_8N1, 16, 17);
  modem.restart();
  M5.Lcd.println(F(&#34;done&#34;));

  M5.Lcd.print(F(&#34;getModemInfo:&#34;));
  String modemInfo = modem.getModemInfo();
  M5.Lcd.println(modemInfo);

  M5.Lcd.print(F(&#34;waitForNetwork()&#34;));
  while (!modem.waitForNetwork()) M5.Lcd.print(&#34;.&#34;);
  M5.Lcd.println(F(&#34;Ok&#34;));

  M5.Lcd.print(F(&#34;gprsConnect(soracom.io)&#34;));
  modem.gprsConnect(&#34;soracom.io&#34;, &#34;sora&#34;, &#34;sora&#34;);
  M5.Lcd.println(F(&#34;done&#34;));

  M5.Lcd.print(F(&#34;isNetworkConnected()&#34;));
  while (!modem.isNetworkConnected()) M5.Lcd.print(&#34;.&#34;);
  M5.Lcd.println(F(&#34;Ok&#34;));

  M5.Lcd.print(F(&#34;My IP addr: &#34;));
  IPAddress ipaddr = modem.localIP();
  M5.Lcd.print(ipaddr);
  delay(2000);
}

void loop() {
  M5.update();

  M5.Lcd.clear(BLACK);
  M5.Lcd.setCursor(0, 0);
  M5.Lcd.println(F(&#34;World Clock from worldtimeapi.org&#34;));

  /* HTTP GET example */
  if (!ctx.connect(&#34;worldtimeapi.org&#34;, 80)) {
    Serial.println(F(&#34;Connect failed.&#34;));
    return;
  }
  Serial.println(F(&#34;connected.&#34;));

  /* send request */
  ctx.println(&#34;GET /api/timezone/Asia/Tokyo.txt HTTP/1.0&#34;);
  ctx.println(&#34;Host: worldtimeapi.org&#34;);
  ctx.println();
  Serial.println(&#34;sent.&#34;);

  /* receive response */
  while (ctx.connected()) {
    String line = ctx.readStringUntil(&#39;\n&#39;);
    Serial.println(line);
    if (line == &#34;\r&#34;) {
      Serial.println(&#34;headers received.&#34;);
      break;
    }
  }
  char buf[1 * 1024] = {0};
  ctx.readBytes(buf, sizeof(buf)); /* body */
  ctx.stop();
  M5.Lcd.println(buf);

  delay(1000 * 10);
}</code></pre>
<h2 is-upgraded>マイコンボードに書き込む</h2>
<p>M5Stack を PC に取り付けた後、Arduino IDE で<img style="width: 33.00px" src="img/6eda9a3a4a4958d7.png">ボタンをクリックします。<strong>ボードへの書き込みが完了しました。</strong>と表示されたら正常終了です。</p>
<aside class="special"><p><strong>ファイルの保存ダイアログが表示されたら</strong></p>
<p>ファイルを保存してください。ファイル名は任意ですが <code>m5stack_3gextboard_worldclock</code> というファイル名はどうでしょうか。</p>
<p>ファイルを保存しない (キャンセル) してもコンパイルとスケッチの転送はされます。</p>
</aside>
<h2 is-upgraded>実行の様子</h2>
<p>最初にモデムの型番や IP アドレスを表示した後に World Time API から取得したデータを表示します。</p>
<aside class="special"><p><code>gprsConnect(soracom.io)</code> から実際に IP アドレスが表示される(= 接続される)までに30~45秒程度掛かりますが正常です。</p>
</aside>
<p class="image-container"><img style="width: 602.00px" src="img/bc9d861d2195eaf6.png"></p>
<p class="image-container"><img style="width: 602.00px" src="img/512538b4a3fe59f8.png"></p>
<h2 is-upgraded>うまく動作しなかった場合</h2>
<table>
<tr><td colspan="1" rowspan="1"><p>症状</p>
</td><td colspan="1" rowspan="1"><p>考えられる原因</p>
</td><td colspan="1" rowspan="1"><p>対策</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>getModemInfo()</code> の結果が <code>SARA-U201...</code> と表示されない(空の場合など)</p>
</td><td colspan="1" rowspan="1"><p>3G 拡張ボードで内部エラーが発生している可能性がある</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.zendesk.com/hc/ja/requests/" target="_blank">カスタマーサポート</a>へご連絡ください。</p>
</td></tr>
<tr><td colspan="1" rowspan="4"><p><code>waitForNetwork()</code> より先に進まない</p>
</td><td colspan="1" rowspan="1"><p>SIM が取り付けられていない。(もしくは SORACOM IoT SIM ではない)</p>
</td><td colspan="1" rowspan="1"><p>SORACOM 特定地域向け IoT SIM plan-D を取り付けてください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>電波が圏外もしくは微弱である可能性がある</p>
</td><td colspan="1" rowspan="1"><p>窓際等、通信条件が良い環境でお試しください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SIM が SORACOM に登録されていない</p>
<p>※ <a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>で確認できます ( &#34;登録されてない&#34; 事が確認できます)</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.github.io/iot-recipes/register-ordering-sim-jp/" target="_blank">発注済みの SIM を登録する</a> もしくは <a href="https://soracom.github.io/iot-recipes/register-byod-sim-jp/" target="_blank">通販サイトやイベント等で入手した SIM を登録する</a> を行ってください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SIM の「状態」が &#34;準備完了&#34; となっている（ &#34;使用中&#34; でない）</p>
<p>※ <a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>で確認できます</p>
</td><td colspan="1" rowspan="1"><p>当該 SIM のチェックボックスをチェックしてから［操作］&gt;［使用開始］をクリックして &#34;使用中&#34; に変更してください。</p>
</td></tr>
</table>
<p>以上で M5Stack の開発環境から M5Stack 本体と 3G 拡張ボードの動作確認が完了しました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="ToF 距離センサーの取り付け" duration="10">
        <p>ToF 距離センサーは Grove ケーブルを使用して M5Stack 横の Grove ポートに接続します。</p>
<h3 is-upgraded>ToF 距離センサー側</h3>
<p class="image-container"><img style="width: 370.50px" src="img/749b428873294101.png"></p>
<h3 is-upgraded>M5Stack 側</h3>
<p class="image-container"><img style="width: 359.50px" src="img/ea2d42689deb3630.png"></p>
<p>ToF センサーは M5Stack の底面に取り付けるのが良いでしょう。私は両面テープで取り付けました。</p>
<p class="image-container"><img style="width: 434.00px" src="img/399b7991eeb5bad.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="スケッチの書き込み" duration="15">
        <p>取り忘れをセンシングするスケッチを M5Stack へ書き込みます。</p>
<h2 is-upgraded>ToF 距離センサーライブラリのインストール</h2>
<p>M5Stack で ToF 距離センサーを利用するためのライブラリをインストールします。今回は<a href="https://github.com/pololu/vl53l0x-arduino" target="_blank">VL53L0X library for Arduino</a>というオープンソースライブラリを利用します。</p>
<h3 is-upgraded>［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;VL53L0X&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>VL53L0X </strong>(by Pololu) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/6a533c1b0244694d.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;VL53L0X&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>VL53L0X</code> と入力すると素早く見つけることができます。Lのあとは数字の &#34;ゼロ&#34; です。似たようなライブラリが表示されるため <strong>by Pololu</strong> という表記を頼りに探してください。</p>
<p class="image-container"><img style="width: 587.00px" src="img/73da2291b20b1550.png"></p>
</aside>
<h2 is-upgraded>JSON 処理ライブラリのインストール</h2>
<p>M5Stack で JSON 形式の構造化テキストを処理するためのライブラリをインストールします。今回は<a href="https://arduinojson.org/?utm_source=meta&utm_medium=library.properties" target="_blank">ArduinoJson</a>というオープンソースライブラリを利用します。</p>
<h3 is-upgraded>［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;ArduinoJson&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>ArduinoJson </strong>(by Benoit Blanchon) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/893f0cbb8a5d7f3c.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;ArduinoJson&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>arduinojson</code> と入力すると素早く見つけることができます。</p>
</aside>
<h2 is-upgraded>HTTP 通信ライブラリのインストール</h2>
<p>M5Stack で HTTP 通信を行うライブラリをインストールします。今回は<a href="https://github.com/arduino-libraries/ArduinoHttpClient" target="_blank">ArduinoHttpClient</a>というオープンソースライブラリを利用します。</p>
<h3 is-upgraded>［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;ArduinoHttpClient&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>ArduinoHttpClient </strong>(by Arduino) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/ac2bba6dd2038a7a.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;ArduinoJson&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>arduinojson</code> と入力すると素早く見つけることができます。</p>
</aside>
<h2 is-upgraded>時間割り込みライブラリのインストール</h2>
<p>M5Stack で時間による割り込み(疑似的に複数の処理を進行させる)ためのライブラリをインストールします。今回は<a href="https://github.com/Toshik/TickerScheduler" target="_blank">TickerScheduler</a>というオープンソースライブラリを利用します。</p>
<p>TickerScheduler はライブラリマネージャーの一覧に無いため、ZIP ファイルのダウンロード → 手動インストールという手順を踏みます。</p>
<h3 is-upgraded>ZIP ファイルをダウンロードする</h3>
<p><a href="https://github.com/Toshik/TickerScheduler" target="_blank">Github</a> を開き、［Clone or Download］&gt;［Download ZIP］をクリックします。すると <code>TickerScheduler-master.zip</code> がダウンロードできます。</p>
<p class="image-container"><img style="width: 525.00px" src="img/182f31de1c661462.png"></p>
<h3 is-upgraded>ZIP 形式のライブラリをインストールする</h3>
<p>(ここからの画面は Windows ですが macOS も同様に進んでください)</p>
<p>Arduino IDE を開き、メニューの［スケッチ］&gt;［ライブラリをインクルード］&gt;［.ZIP 形式のライブラリをインストール...］と進みます。<img style="width: 581.00px" src="img/56d65f5035565ca4.png"></p>
<p>ダイアログで先ほどダウンロードしたファイル <code>TickerScheduler-master.zip</code> を選択して［開く］をクリックします。</p>
<p class="image-container"><img style="width: 516.00px" src="img/e3aaf12180b675b1.png"></p>
<aside class="special"><p><strong>TickerScheduler-master.zip はどこにある？</strong></p>
<p>ブラウザでダウンロードしたファイルは「ダウンロード」フォルダに保存されていることがほとんどです。(アルファベットで Downloads となっている場合もあります)</p>
</aside>
<p>以上でインストールは完了です。</p>
<h2 is-upgraded>スケッチを入手する</h2>
<p>Arduino IDE を起動し［ファイル］&gt;［新規ファイル］を開くと void setup() { から始まる「空のスケッチ」が表示されます。</p>
<p>一度スケッチの内容を削除してから、<a href="https://gist.githubusercontent.com/ma2shita/76c563550448a08b92f0614f8d772921/raw/cff5d7d792e69367b97a5b93478a8f2ecd6b7fce/m5stack_tof_ranger.ino" target="_blank">m5stack_tof_ranger.ino</a> の内容と置き換えてください。</p>
<aside class="special"><p><a href="https://gist.githubusercontent.com/ma2shita/76c563550448a08b92f0614f8d772921/raw/cff5d7d792e69367b97a5b93478a8f2ecd6b7fce/m5stack_tof_ranger.ino" target="_blank">m5stack_tof_ranger.ino</a> の基となっている Gist (コード共有サイト) の URL は<a href="https://gist.github.com/ma2shita/76c563550448a08b92f0614f8d772921" target="_blank">こちら</a>です。</p>
</aside>
<h2 is-upgraded>マイコンボードに書き込む</h2>
<p>M5Stack を PC に取り付けた後、Arduino IDE で<img style="width: 33.00px" src="img/6eda9a3a4a4958d7.png">ボタンをクリックします。<strong>ボードへの書き込みが完了しました。</strong>と表示されたら正常終了です。</p>
<aside class="special"><p><strong>ファイルの保存ダイアログが表示されたら</strong></p>
<p>ファイルを保存してください。ファイル名は任意ですが <code>m5stack_tof_ranger</code> というファイル名はどうでしょうか。</p>
<p>ファイルを保存しない (キャンセル) してもコンパイルとスケッチの転送はされます。</p>
</aside>
<p>以上で書き込みは完了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="設置とパラメータの決定" duration="15">
        <p>「コーヒーカップの有無」を検出するためのパラメータを決定していくために、<strong>計測モード</strong>で設置を行います。</p>
<p><strong>計測モード</strong>とはクラウドとの通信をせずに距離のセンシングのみを行うモードです。設置した際に得られた計測データを基に、「コーヒーカップの有無」を検出するためのパラメータを決定していきます。</p>
<aside class="special"><p><strong>M5Stack は PC につながなくても動きます</strong></p>
<p>M5Stack は スケッチを M5Stack に転送する時以外は PC に接続しなくとも動作します。USB AC アダプタと USB Type-C ケーブルがあれば、それを電源として利用できます。</p>
</aside>
<aside class="special"><p><strong>本スケッチの標準設定値</strong></p>
<p>以下のように、バリスタの隣に設置する事を想定した値があらかじめ設定されています。このように設置できる場合は本ステップの作業は不要です。</p>
<p>図のように近接して設置できない場合やカップサイズが大幅に異なる時には、本章の作業を行ってパラメータの決定をしてください。ちなみに数値はHIGH = 75mm, LOW = 20mm となります。</p>
<p class="image-container"><img style="width: 587.00px" src="img/bec4796948e35a00.png"></p>
</aside>
<h2 is-upgraded>コーヒーカップの有無を検出する仕組みとパラメータ</h2>
<p>コーヒーカップがない場合は、バリスタのカバー部分までの距離が返ってきます。こーひカップが置かれるとカップまでの距離が返ってくるため、その情報で「有無」を見分ける仕組みです。</p>
<p class="image-container"><img style="width: 602.00px" src="img/61fc15007e2f8379.png"></p>
<h3 is-upgraded>計測誤差を吸収するためのパラメータ</h3>
<p>センサーは誤差が発生するものです。また、コーヒーカップの置き場所の微妙な違いによるズレも生じることから、誤差を吸収する仕組みが必要です。本スケッチでは「複数回の計測」と「範囲の指定」という2つの方法で計測誤差を取り除いています。</p>
<p>「複数回の計測」は、何度か計測をして正確な値を確率的に得る方法です。本スケッチでも同様の手法を実装しており、標準設定では5回計測するようにしています。</p>
<p>2つ目の「範囲の指定」は、LOW と HIGH というパラメータを用意しその中に収まっているか否かで判定する仕組みです。この2つのパラメータを調整することで、設置場所に柔軟性を持たせることが可能です。</p>
<p class="image-container"><img style="width: 602.00px" src="img/25a6ec7c07b867ca.png"></p>
<p>これにより、ある程度ずれても「範囲の内外」を「コーヒーカップの有無」として判定することができます。</p>
<h2 is-upgraded>M5Stack を計測モードで起動する</h2>
<p>M5Stack の A ボタン(3つあるうちの一番左のボタン)を押しながら、電源ボタン(側面のボタン)を押してください。<code>Skip fetching config from Cloud</code> と表示され、すぐにメイン画面に移行します。</p>
<p>一行目に <code>Config (by Local)</code> と表示されていれば計測モードです。</p>
<p class="image-container"><img style="width: 480.00px" src="img/f271f68fd6e4332d.gif"></p>
<h2 is-upgraded>設置して計測値をメモしておく</h2>
<p>M5Stack を実際に設置します。この時、画面の <code>Oneshot Measurement</code> の数値に注目します。</p>
<p class="image-container"><img style="width: 498.00px" src="img/412632175c99444b.png"></p>
<p>カップを置かずに得た数値の概ねの平均値の 10%増を HIGH としてメモします。(例: 概ね120mm であれば <code>132</code> を HIGH とする)。また、カップを置いた時の概ね平均値の 10%減の値を LOW としてメモします。(例: 概ね60mm であれば <code>54</code> を LOW とする)。</p>
<p>メモが出来たら次に進みます。</p>
<aside class="special"><p><strong>±10% について</strong></p>
<p>ToF 距離センサーは誤差の範囲が大きい場合があるため、約10%~15%程の余裕を持たせるようにしています。この辺りは実際に設置してみて決定してください。</p>
</aside>
<aside class="special"><p><strong>Oneshot Measurement, Sampling Measurementについて</strong></p>
<p>Oneshot Measurement = 0.5秒毎に計測をし続けている値となります。実際に設置してみると数mm レベルでの誤差が確認できるでしょう。</p>
<p>Sampling Measurement = カウントダウン終了後に5回連続で計測し、LOW 以下と HIGH 以上の値(外れ値)を除外した平均値です。</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="メタデータサービスにパラメータを指定する" duration="5">
        <p>メモをしたパラメータを「SORACOM Air メタデータサービス」に保存します。</p>
<aside class="special"><p><strong>標準設定値をそのまま使える場合は？</strong></p>
<p>前ステップで計測した結果、標準設定値(HIGH = 75mm, LOW = 20mm)がそのまま利用できる場合は、本ステップは飛ばすことができます。</p>
</aside>
<aside class="special"><p><strong>メタデータとは？</strong></p>
<p>通信回線(SIM)に関するデータで、回線管理のために使用します。たとえば SIM を一意に識別することができる IMSI といった静的な情報から、現在の通信状況や回線速度といった動的な情報を取得することができます。また、ユーザー自身によって回線に対して「タグ付け」が可能です。タグは名前(キー)と値(バリュー)の対になっており、たとえば「使用部門」というキーを作り、その値に「開発部」と設定が可能です。設定だけでは無く、API によって読み出すこともできる他、SORACOM IoT SIM を使った回線からであれば、SIM によって認証が完了しているため、自 SIM の情報は認証なしで取得・更新可能となっています。</p>
</aside>
<h2 is-upgraded><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>の［Menu］&gt;［SIM 管理］とクリックして SIM 管理画面を開きます。</h2>
<p class="image-container"><img style="width: 566.00px" src="img/15d42beb5503d417.png"></p>
<aside class="warning"><p><strong>［SIM 管理］をクリックしても画面が切り替わらない場合は？</strong></p>
<p>すでに SIM 管理画面を開いている場合は、［SIM 管理］をクリックしても画面が切り替わることがありません。その場合、青の点線で囲まれている「SORACOM ロゴ」をクリックすることでメニューを閉じることができます。</p>
</aside>
<h2 is-upgraded>メタデータを設定したい SIM (Wio LTE に取り付けた SIM) にチェックを付け、［詳細］をクリックします。</h2>
<p class="image-container"><img style="width: 442.50px" src="img/74eebe328c3963d0.png"></p>
<aside class="warning"><p>「詳細」は複数チェックによる操作ができないため、複数行いたい場合は一つづつ行います。</p>
</aside>
<h2 is-upgraded>「SIM 詳細」で［タグ］&gt;<img style="width: 52.00px" src="img/beddcc116acb43a.png">をクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/330780889df6f6e.png"></p>
<h2 is-upgraded>「タグの編集」で以下のように設定します。</h2>
<p>この時 CUT_VALUE_LOW_MM の <code>20</code> には先ほどメモをした LOW の値を、CUT_VALUE_HIGH_MM の <code>70</code> には先ほどメモをした HIGH の値になるようにしてください。</p>
<p>例: メモした LOW が 54、HIGH が 132 であれば <code>{&#34;CUT_VALUE_LOW_MM&#34;: 54, &#34;CUT_VALUE_HIGH_MM&#34;: 132}</code> とします。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>設定値</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>名前</p>
</td><td colspan="1" rowspan="1"><p><code>config_json</code></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>値</p>
</td><td colspan="1" rowspan="1"><p><code>{&#34;CUT_VALUE_LOW_MM&#34;: 20, &#34;CUT_VALUE_HIGH_MM&#34;: 75}</code></p>
</td></tr>
</table>
<p>※1行で入力してください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/131b926f25a11ebb.png"></p>
<p>最後に［保存］をクリックし、「SIM 詳細」では［閉じる］をクリックしてください。</p>
<p>これで、SIM に対してタグ付けが完了しました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Air メタデータサービスと SORACOM Harvest Data の設定をする" duration="5">
        <p>M5Stack に取り付けた SIM に「SORACOM Air メタデータサービス」と「SORACOM Harvest Data」の設定を行います。</p>
<h2 is-upgraded><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>の［Menu］&gt;［SIM 管理］とクリックして SIM 管理画面を開きます。</h2>
<p class="image-container"><img style="width: 566.00px" src="img/15d42beb5503d417.png"></p>
<aside class="warning"><p><strong>［SIM 管理］をクリックしても画面が切り替わらない場合は？</strong></p>
<p>すでに SIM 管理画面を開いている場合は、［SIM 管理］をクリックしても画面が切り替わることがありません。その場合、青の点線で囲まれている「SORACOM ロゴ」をクリックすることでメニューを閉じることができます。</p>
</aside>
<h2 is-upgraded>M5Stack に取り付けた SIM) にチェックを付け、［操作］&gt;［所属グループ変更］とクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/c06eff415539cb53.png"></p>
<aside class="special"><p><strong>SORACOM の便利な使い方: 複数の SIM を同時に扱う</strong></p>
<p>チェックをつける対象を複数にすれば、一度の複数の SIM を対象に操作が可能です。</p>
</aside>
<h2 is-upgraded>「新しい所属グループ」のプルダウンボックスをクリックした後、［新しいグループを作成...］をクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/9cf95365d7028f2c.png"></p>
<h2 is-upgraded>「グループ作成」のグループ名を入力して［グループ作成］をクリックします。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>例</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>グループ名</p>
</td><td colspan="1" rowspan="1"><p><code>poka-yoke-notifier</code></p>
</td><td colspan="1" rowspan="1"><p>自由に入力可能です。日本語も設定可能です。</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 385.00px" src="img/17d79112e7739a7b.png"></p>
<h2 is-upgraded>SIM 管理画面で割り当てたグループ名をクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/ae57a6f509c22058.png"></p>
<h2 is-upgraded>［SORACOM Air for Cellular 設定］をクリックして設定が出来るように開きます。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/1dfe6a04bedbb32e.png"></p>
<h2 is-upgraded>「SORACOM Air for Cellular 設定」で以下のように設定します。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>設定値</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>メタデータサービス設定（スイッチ）</p>
</td><td colspan="1" rowspan="1"><p>ON</p>
</td><td colspan="1" rowspan="1"><p>スイッチはクリックすることで OFF から ON に切り替えることができます</p>
</td></tr>
</table>
<p>※ その他の項目の変更や編集は不要です。</p>
<p class="image-container"><img style="width: 262.00px" src="img/a791e816f65824dd.png"><br></p>
<p>その後［保存］をクリックしてください。また、同じページ内での設定が続くため、ページは閉じないでください。</p>
<h2 is-upgraded>［SORACOM Harvest Data 設定］をクリックして設定ができるように開きます。</h2>
<p>先ほどの設定を行ったページ内にあります。</p>
<p class="image-container"><img style="width: 602.00px" src="img/e29cf80f5c89ba1f.png"></p>
<h2 is-upgraded>「SORACOM Harvest Data 設定」で以下のように設定します。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>設定値</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>（スイッチ）</p>
</td><td colspan="1" rowspan="1"><p>ON</p>
</td><td colspan="1" rowspan="1"><p>スイッチはクリックすることで OFF から ON に切り替えることができます。</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 262.00px" src="img/b8dd4f4f9fc5f281.png"></p>
<p>その後［保存］をクリックしてください。<br>その後表示される「SORACOM Harvest Data が有効になっています」のダイアログでは［OK］をクリックしてください。</p>
<p>以上で「SORACOM Air メタデータサービス」と「SORACOM Harvest Data」の設定が完了しました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Harvest Data でデータを確認する" duration="10">
        <p>デバイスからのデータを SORACOM Harvest Data で確認します。</p>
<h2 is-upgraded><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>の［Menu］&gt;［SIM 管理］とクリックして SIM 管理画面を開きます。</h2>
<p class="image-container"><img style="width: 566.00px" src="img/15d42beb5503d417.png"></p>
<aside class="warning"><p><strong>［SIM 管理］をクリックしても画面が切り替わらない場合は？</strong></p>
<p>すでに SIM 管理画面を開いている場合は、［SIM 管理］をクリックしても画面が切り替わることがありません。その場合、青の点線で囲まれている「SORACOM ロゴ」をクリックすることでメニューを閉じることができます。</p>
</aside>
<h2 is-upgraded>M5Stack に取り付けた SIM) にチェックを付け、［操作］&gt;［データを確認］とクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/b85c817ce051c1f0.png"></p>
<h2 is-upgraded>表示された画面で［自動更新］を ON にします。</h2>
<p>この表示された画面が SORACOM Harvest Data の画面となります。</p>
<aside class="special"><p><strong>自動更新とは？</strong></p>
<p>画面を再読み込みしなくとも新しいデータが自動的に表示されるようにする機能です。5秒毎に新しいデータを表示するようになります。この機能が OFF の場合は、表示する期間を指定して［検索］をクリックすることで期間内のデータを表示できます。</p>
</aside>
<p class="image-container"><img style="width: 602.00px" src="img/6f1ba96bafc86abd.png"></p>
<h2 is-upgraded>M5Stack の電源ボタン(側面のボタン)を一度押してリセットします</h2>
<p>(A ボタンなど何も押さずに) 起動すると<strong>データ送信モード</strong>として動作し、クラウド(SORACOM Harvest Data) へデータ送信が開始されます。一行目に <code>Config (by Cloud)</code> もしくは <code>Config (by Default)</code> と表示されていればデータ送信モードです。</p>
<p>データ送信モードの時は起動時にクラウド(SORACOM Air メタデータサービス)から設定情報を読み込むため、起動に約30~40秒ほどかかります。また SORACOM Air メタデータサービスで設定した値は画面上に表示されますので、設定が正しくできているか確認できます。（自分で設定した値とは異なる情報が出ている場合は、正しく設定できていない可能性があるため、メタデータの設定を再確認してください）</p>
<p class="image-container"><img style="width: 475.50px" src="img/3ac8081e69f87eda.png"></p>
<h2 is-upgraded>コーヒーカップを置いてみる</h2>
<p>本スケッチでは「5分毎にコーヒーカップの有無を確認し、ある時にデータ送信をする（＝無い時にはデータ送信を行わない）」仕組みです。実際にコーヒーカップを置いてみて、データが送信されるか確認します。</p>
<p>次回の計測タイミングは Sampling Measurement の &#34;Left&#34; に残り秒数が表示されていますので目安にしてください。</p>
<p>Left が 0s になると計測と判定がされます。コーヒーカップが「無い」と判定されれば <code>nan mm</code> と表示され、「ある」と判定されれば、コーヒーカップまでの平均距離が mm 単位で表示されます。(nan = Not a Number; 非数)</p>
<p class="image-container"><img style="width: 602.00px" src="img/8f6241bbf27f535b.png"></p>
<p class="image-container"><img style="width: 602.00px" src="img/b69ba3591298a4fa.png"></p>
<p>SORACOM Harvest Data では以下のように確認できます。コーヒーカップを置いて15分ほど放置した様子です。</p>
<p class="image-container"><img style="width: 602.00px" src="img/127952407f9cfc86.png"></p>
<p>以上でデータ送信の確認は終了です。</p>
<aside class="warning"><p><strong>データが送信されない？</strong></p>
<p>M5Stack の設置位置や LOW と HIGH のパラメータを見直してください。パラメータは SORACOM Air メタデータサービスの config_json タグで調整します。変更した後は M5Stack をリセットしてください。起動時に新しいパラメータを読み込みます。</p>
</aside>
<aside class="special"><p><strong>5分毎の判定タイミングを変更したい？</strong></p>
<p><code>MEASUREMENT_INTERVAL_SEC</code> というパラメータを、 SORACOM Air メタデータサービスの config_json タグの値で設定します。標準では 300 (=300秒 = 5分)となっています。</p>
<p>30秒毎に変更する例:<br><code>{&#34;CUT_VALUE_LOW_MM&#34;: 20, &#34;CUT_VALUE_HIGH_MM&#34;: 75, &#34;MEASUREMENT_INTERVAL_SEC&#34;: 30}</code></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Funk と Hosted Funk でメール送信をする" duration="10">
        <p>「コーヒーカップがある」時にデータが送信されてくるため、そのタイミングでメールの通知を行えるように設定してみましょう。そのためには、クラウドファンクションアダプタ <a href="https://soracom.jp/services/funk/" target="_blank"><strong>SORACOM Funk</strong></a> を利用します。</p>
<aside class="special"><p><strong>SORACOM Funk とは？</strong></p>
<p>SORACOM Funk は、クラウドサービスの Function を直接実行できるサービスです。</p>
<p>一般的にIoTデバイスは電力消費などを抑える目的からシンプルな構成であることが多く、そのような場合はデバイス側での複雑なデータ処理が難しい場合があります。また、デバイス側がこのような複雑なデータ処理が可能な場合も、多くの電力を消費します。</p>
<p>そのような場合、FaaS(Function as a Service)と連携することで、IoTデバイスのリソースを使用することなく、クラウドの膨大なリソースで複雑な処理を実行することができます。クラウドが提供する FaaS として、以下の3つに対応しています。</p>
<ul>
<li>AWS Lambda</li>
<li>Azure Functions</li>
<li>GCP Cloud Functions</li>
</ul>
</aside>
<p>本ハンズオンでは、あらかじめソラコムが用意した AWS アカウントの Lambda Function (Hosted Funk) を利用することで、簡単にメールが送信が可能です。</p>
<h2 is-upgraded><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>の［Menu］&gt;［SIM 管理］とクリックして SIM 管理画面を開きます。</h2>
<p class="image-container"><img style="width: 566.00px" src="img/15d42beb5503d417.png"></p>
<aside class="warning"><p><strong>［SIM 管理］をクリックしても画面が切り替わらない場合は？</strong></p>
<p>すでに SIM 管理画面を開いている場合は、［SIM 管理］をクリックしても画面が切り替わることがありません。その場合、青の点線で囲まれている「SORACOM ロゴ」をクリックすることでメニューを閉じることができます。</p>
</aside>
<h2 is-upgraded>SIM 管理画面で割り当てたグループ名をクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/ae57a6f509c22058.png"></p>
<h2 is-upgraded>［SORACOM Air for Cellular 設定］をクリックして設定が出来るように開きます。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/1dfe6a04bedbb32e.png"></p>
<h2 is-upgraded>「SORACOM Air for Cellular 設定」で以下のように設定します。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>設定値</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>メタデータサービス設定 / ユーザーデータ</p>
</td><td colspan="1" rowspan="1"><p><code>下記の文章を指定</code></p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
</table>
<p>※ その他の項目の変更や編集は不要です。</p>
<p>文章</p>
<pre>コーヒーマシンからのお知らせ：コーヒーカップが置きっぱなし？
&#123;&#123;etc.timestamp}} のことですが、コーヒーカップが置きっぱなしのようです。
確認するようにしてください。
(計測の平均距離は&#123;&#123;event.avg_mm}} mm でした)</pre>
<p><img style="width: 602.00px" src="img/926d95efbab0225b.png"><br>その後［保存］をクリックしてください。また、同じページ内での設定が続くため、ページは閉じないでください。</p>
<h2 is-upgraded>［SORACOM Funk 設定］をクリックして設定が出来るように開きます。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/6b31affd60132d14.png"></p>
<h2 is-upgraded>「SORACOM Funk 設定」で以下のように設定します。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>設定値</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>(スイッチ)</p>
</td><td colspan="1" rowspan="1"><p>ON</p>
</td><td colspan="1" rowspan="1"><p>スイッチはクリックすることで OFF から ON に切り替えることができます。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>サービス</p>
</td><td colspan="1" rowspan="1"><p>AWS Lambda</p>
</td><td colspan="1" rowspan="1"><p>デフォルトで選択されています。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>送信データ形式</p>
</td><td colspan="1" rowspan="1"><p>JSON</p>
</td><td colspan="1" rowspan="1"><p>デフォルトで選択されています。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>認証情報</p>
</td><td colspan="1" rowspan="1"><p>認証情報を指定しない</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>関数の ARN</p>
</td><td colspan="1" rowspan="1"><p><code>下記の ARN を指定</code></p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
</table>
<p>ARN</p>
<pre>arn:aws:lambda:ap-northeast-1:762707677580:function:funk-button-email:prod</pre>
<p class="image-container"><img style="width: 515.00px" src="img/16b8f4f4568a6e6b.png"></p>
<p>以上で設定は完了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="メールを確認してみる" duration="1">
        <p>M5Stack がコーヒーカップの存在を検出すると、以下のようなメールが SORACOM ユーザコンソールに登録した際のメールアドレスに送信されます。</p>
<p class="image-container"><img style="width: 602.00px" src="img/ce8cb96d90703c0.png"></p>
<aside class="special"><p><strong>他のメールアドレスに送信したい場合は？</strong></p>
<p>SIM の「タグ」に <code>mail_to</code> という名前で登録した値に、送りたい先のメールアドレスが指定できます。</p>
<p class="image-container"><img style="width: 587.00px" src="img/815538ba34cdf54c.png"></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="その他の機能や運用に向けた設定" duration="1">
        <p>ここからは、これまで紹介していなかった機能や、本番に向けた設定を紹介します。</p>
<h2 is-upgraded>LCD (液晶)画面の消灯</h2>
<p>M5Stack の LCD 画面は C ボタン(一番右のボタン)を押すことで、消灯することができます。消灯後、再度 C ボタンを押すと点灯します。</p>
<p class="image-container"><img style="width: 475.50px" src="img/3eb73547e894a90b.png"></p>
<p>標準では起動時には常に点灯するようになっていますが、 config_json で <code>&#34;LCD_TURN_ON_AT_BOOT&#34;: false</code> とすることで起動後に自動的に消灯させることができます。消灯状態で起動しても C ボタンで点灯が可能です。</p>
<h2 is-upgraded>SORACOM Harvest Data の OFF</h2>
<p>通知がき始めたら運用が開始できます。データの記録が不要であれば SORACOM Harvest Data を OFF にしておきましょう。</p>
<p>こうすることで 5円/SIM/日 の費用を抑えることができます。</p>
<h2 is-upgraded>config_json パラメータリファレンス</h2>
<p>これまで <code>CUT_VALUE_LOW_MM</code> や <code>CUT_VALUE_HIGH_MM</code> 、 <code>MEASUREMENT_INTERVAL_SEC</code> といったパラメータを紹介してきましたが、ここで全てのパラメータを紹介します。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>パラメータ名</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>役割</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>デフォルト値</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>CUT_VALUE_LOW_MM</code></p>
</td><td colspan="1" rowspan="1"><p>物体が「ある」と判定するための最短距離。単位は mm 。</p>
</td><td colspan="1" rowspan="1"><p>20 (mm)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>CUT_VALUE_HIGH_MM</code></p>
</td><td colspan="1" rowspan="1"><p>物体が「ある」と判定するための最長距離。単位は mm 。</p>
</td><td colspan="1" rowspan="1"><p>75 (mm)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>MEASUREMENT_INTERVAL_SEC</code></p>
</td><td colspan="1" rowspan="1"><p>物体の有無を計測する間隔。単位は秒。</p>
</td><td colspan="1" rowspan="1"><p>300 (秒)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>LCD_TURN_ON_AT_BOOT</code></p>
</td><td colspan="1" rowspan="1"><p>起動後の LCD 画面の制御。true で点灯、 false で消灯。</p>
</td><td colspan="1" rowspan="1"><p>true</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>SEND_TO_CLOUD</code></p>
</td><td colspan="1" rowspan="1"><p>クラウド(SORACOM)への送信制御。 true で送信する、 false で送信しない。</p>
</td><td colspan="1" rowspan="1"><p>計測モードの時は false</p>
<p>送信モードの時は true</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>_ONESHOT_MEASUREMENT_INTERVAL_MS</code></p>
</td><td colspan="1" rowspan="1"><p>&#34;Oneshot measurement&#34; による計測間隔。単位はミリ秒。</p>
</td><td colspan="1" rowspan="1"><p>500 (ms)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>_SAMPLING_COUNT</code></p>
</td><td colspan="1" rowspan="1"><p>物体の有無を計測する際に試行する回数。単位は回。</p>
</td><td colspan="1" rowspan="1"><p>5 (回)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>_SAMPLING_INTERVAL_MS</code></p>
</td><td colspan="1" rowspan="1"><p>物体を計測する際の試行間隔。単位はミリ秒。</p>
</td><td colspan="1" rowspan="1"><p>200 (ms)</p>
</td></tr>
</table>


      </google-codelab-step>
    
      <google-codelab-step label="あとかたづけと注意事項" duration="1">
        <p>本レシピでは費用がかかるサービスを利用しています。<br>本項をよく読み、必要な操作や解除作業を行うようにして、想定外の費用が掛からないようにしてください。</p>
<h2 is-upgraded>費用について</h2>
<p>ここで記載している金額は全て税別、送料別となります。</p>
<h3 is-upgraded>SORACOM プラットフォームの利用料金</h3>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>サービス／機能</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>料金</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="2"><p><a href="https://soracom.jp/services/air/cellular/price_specific_area_sim/" target="_blank">SORACOM Air (plan-D)</a></p>
</td><td colspan="1" rowspan="1"><p>基本料: 10円/日</p>
<p>通信料: 0.2円~/MB</p>
<p>(今回の利用であれば 1MB 以内で収まる範囲)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SORACOM Air メタデータサービスの利用料は基本料に含まれています</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/services/harvest/price/" target="_blank">SORACOM Harvest Data</a></p>
</td><td colspan="1" rowspan="1"><p>本機能を有効にしたグループに所属する1SIMあたり5円/日 (2000リクエスト/日/SIMを含む)</p>
<p>2000リクエスト/日を超えた分は0.004円/リクエスト</p>
</td></tr>
<tr><td colspan="1" rowspan="2"><p><a href="https://soracom.jp/services/funk/price/" target="_blank">SORACOM Funk</a></p>
</td><td colspan="1" rowspan="1"><p>0.0018円/リクエスト</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Hosted Funk の利用料はリクエスト料金に含まれています (今後のサービスアップデートで改訂される可能性があるため、料金表でご確認ください)</p>
</td></tr>
</table>
<p>※ 費用詳細はリンク先をご確認ください。</p>
<aside class="special"><p><strong>無料利用枠について</strong></p>
<p>SORACOM サービスでは一部サービスにおいて無料枠が設定されています。たとえば SORACOM Air for セルラーであればアカウント毎で30円/月の通信分や、SORACOM Funk であれば50,000リクエスト/月などです。料金詳細に「無料利用枠」として掲載されていますので、ご確認ください。</p>
</aside>
<h2 is-upgraded>グループ解除</h2>
<p>SORACOM Harvest Data 等、「機能が有効になっているグループに所属している SIM × 費用」となっているサービスにおいては、「機能を OFF にする」することで費用の発生を抑えることができます。またもう1つの方法として「グループに所属している SIM の数を減らす(= 解除する)」事でも費用を抑える事ができます。</p>
<p>また、SORACOM Funk はリクエスト発生時毎の従量課金となっているため、作成したグループ内の設定が SORACOM Funk のみとなっていれば、リクエストが発生しなければ費用は発生しません。</p>
<p>グループ解除の方法は<a href="https://soracom.github.io/iot-recipes/unjoin-from-group/" target="_blank">グループからの解除 (JP)</a>をご覧ください。</p>
<h2 is-upgraded>SORACOM Harvest Data のデータ削除（任意）</h2>
<p>SORACOM Harvest Data は基本的にはデータ保管料は無料※です。そのため、保存しておいても害はありませんが、デモ等で利用する際にはデータを綺麗にしておく必要が出てくるため、データ削除について解説します。</p>
<p>※発生から40日を超えたデータは削除されます。40日以上データを保管したい場合は<a href="https://soracom.jp/services/harvest/price/" target="_blank">データ保持期間延長オプション利用料金</a>をご利用ください。</p>
<p>SORACOM Harvest Data 画面 (［操作］&gt;［データを確認］) のデータテーブルで、削除したいデータのチェックボックスを付けた後に［削除］をクリックします。表示されたダイアログで改めて［削除］をクリックすると、削除されます。<br>※ 複数のデータにチェックをつければ一括で削除可能です。</p>
<p class="image-container"><img style="width: 414.00px" src="img/637cac3bf206c47c.png"></p>
<p><strong>データの復元はできません</strong>のでご注意ください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="次のステップ" duration="1">
        <p>本レシピでは、M5Stack と 3G 拡張ボードと ToF 距離センサーを組み合わせた「コーヒーカップ取り忘れ通知デバイス」を作りました。</p>
<p>「距離」によるセンシングは、計測される側（今回はコーヒーカップ）の改造をせずとも物体の有無を簡単に判定できることから、応用例も多く考えられるのではないでしょうか？</p>
<p>今回は ToF 距離センサーを利用しましたが、その他にも<a href="https://www.switch-science.com/catalog/1383/" target="_blank">超音波を利用した距離センサー</a>もあります。センシングする対象や環境に応じて使い分けることもできるでしょう。</p>
<p><a href="https://soracom.jp/products/kit/3g_module_m5stack_set/" target="_blank">商品ページへ戻る</a></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://soracom.github.io/iot-recipes/codelab-elements/native-shim.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/custom-elements.min.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/prettify.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/codelab-elements.js"></script>

</body>
</html>
