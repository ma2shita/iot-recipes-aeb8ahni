
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>【IoT DIY レシピ】M5Stack と 3G拡張ボードで作る「コーヒーカップ取り忘れお知らせデバイス」</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://soracom.github.io/iot-recipes/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-66865146-33"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="poka-yoke-for-coffee-dispenser-by-m5stack"
                  title="【IoT DIY レシピ】M5Stack と 3G拡張ボードで作る「コーヒーカップ取り忘れお知らせデバイス」"
                  environment="web"
                  feedback-link="https://soracom.jp/products/kit/3g_module_m5stack_set/">
    
      <google-codelab-step label="M5Stack と 3G 拡張ボードで作る「コーヒーカップ取り忘れお知らせデバイス」" duration="1">
        <p>公開日: 2020年12月</p>
<p>レシピ難易度：★★☆☆☆</p>
<p>LCD付きプロトタイピング向けマイコンキット &#34;M5Stack&#34; にモバイルデータ通信機能を加える &#34;3G 拡張モジュール&#34; を組み合わせて、コーヒーマシンに置き忘れたカップをメールでお知らせしてくれるデバイスを作ります。</p>
<p class="image-container"><img style="width: 601.70px" src="img/6f24eaaabccb5ccc.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/48ad117bad6411c9.png"></p>
<p class="image-container"><img style="width: 601.70px" src="img/6274fd0365033d7b.png"></p>
<h2 is-upgraded>全体の構成</h2>
<p class="image-container"><img style="width: 602.00px" src="img/7a428c284440fc8c.png"></p>
<h3 is-upgraded>使用する SORACOM サービス</h3>
<ul>
<li>データ通信サービス <a href="https://soracom.jp/services/air/" target="_blank">SORACOM Air</a></li>
<li>データ収集・蓄積サービス <a href="https://soracom.jp/services/harvest/" target="_blank">SORACOM Harvest Data</a></li>
<li>ダッシュボード作成・共有サービス <a href="https://soracom.jp/services/lagoon/" target="_blank">SORACOM Lagoon</a></li>
</ul>
<h2 is-upgraded>本レシピを行うのに必要な時間、概算費用</h2>
<p>本レシピは以下の通りです。</p>
<ul>
<li>必要な時間: 約1時間30分</li>
<li>概算費用: 約15,500円</li>
</ul>
<p>※ 概算費用: ハードウェアや SORACOM を始めとした各種サービスの概ねの費用 (税や送料などの付帯費用や無料枠適用は考慮しないものとしています)</p>
<h2 is-upgraded>このコンテンツの進め方</h2>
<p>ページの内容を読み、また作業を行ったら右下の［Next］を押して次のステップへ進みます。また、［Back］を使って戻ったり、左のナビゲーションメニューでもページの移動が可能です。</p>
<p>左上の［×］を押してコンテンツを終了することができます。また、ページを開きなおすことで再開できます。ページのアドレスはブラウザの［履歴］メニューを利用してください。</p>

<aside class="warning"><p>本コンテンツは現状のままで提供され、株式会社ソラコムは、誤りがないことの保証を含め、明示であると黙示であるとを問わず、本コンテンツの記載内容につき、いかなる種類の表明も保証も行いません。</p>
<p>掲載情報の閲覧及び利用により、利用者自身、もしくは第三者が被った損害に対して、直接的、間接的を問わず、株式会社ソラコムは責任を負いかねます。</p>
<p>本コンテンツを実践する中で用意された機器、利用されたサービスについてのご質問は、それぞれの機器やサービスの提供元にお問い合わせをお願いします。機器やサービスの仕様は、本コンテンツ作成当時のものです。</p>
<p>株式会社ソラコムが提供する機器・サービスについてのご質問は、 <a href="https://soracom.jp/contact/" target="_blank">https://soracom.jp/contact/</a> をご確認の上、適切な窓口へのお問い合わせをお願いします。機器・サービスご利用前の導入相談は <a href="https://soracom.jp/contact/contactsales/" target="_blank">https://soracom.jp/contact/contactsales/</a> に、機器・サービスご利用開始後のサポートは、SORACOMユーザーコンソール内の<a href="https://soracom.zendesk.com/hc/ja/requests/" target="_blank">サポートサイトから「リクエストを送信」</a>(要ログイン)にてお問い合わせください。</p>
<p>本ドキュメントは <a href="https://github.com/googlecodelabs/tools" target="_blank">CLaaT</a> を用いて制作しています</p>
<p>Copyright (c) 2020 SORACOM, INC.</p>
</aside>



      </google-codelab-step>
    
      <google-codelab-step label="準備" duration="1">
        <p>本レシピを行うためには以下のものをご用意ください。</p>
<h2 is-upgraded>ハードウェア</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>品名</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>数量</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>価格</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>購入先</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>M5Stack Basic 3G 拡張ボード セット</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>12,800円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/products/kit/3g_module_m5stack_set/" target="_blank">ソラコム</a></p>
</td><td colspan="1" rowspan="1"><p>M5Stack と <a href="https://soracom.jp/products/kit/3g_module_m5stack/" target="_blank">M5Stack 用 3G 拡張ボード</a>をそれぞれ準備いただいてもレシピを進めることができます。</p>
<p>M5Stack 用 3G 拡張ボードが対応している M5Stack は <a href="https://www.switch-science.com/catalog/3647/" target="_blank">Basic</a> と <a href="https://www.switch-science.com/catalog/3648/" target="_blank">Gray</a> の2モデルです。M5Stack FIRE は非対応ですのでご注意ください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SORACOM 特定地域向け IoT SIM (plan-D / データ通信のみ / nanoSIM サイズ)</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>852円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/products/sim/plan-d/" target="_blank">ソラコム</a></p>
<p><a href="https://www.amazon.co.jp/dp/B07WMQ49W3/" target="_blank">Amazon.co.jp</a></p>
</td><td colspan="1" rowspan="1"><p>サイズは nano をお求めください。「マルチカット」には nano サイズが含まれています。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>対辺1.5mm 六角レンチ(ドライバー)</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約410円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://www.amazon.co.jp/dp/B00B4TCYIW/" target="_blank">Amazon.co.jp</a></p>
</td><td colspan="1" rowspan="1"><p>M5Stack 用 3G 拡張ボードへ SIM を挿す際にボードの取り付け・取り外しに使用します。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>M5Stack用ToF測距センサユニット</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>約1,430円</p>
</td><td colspan="1" rowspan="1"><p><a href="https://www.switch-science.com/catalog/5219/" target="_blank">スイッチサイエンス</a></p>
</td><td colspan="1" rowspan="1"><p>光を利用した距離センサーです。取り付け用の Grove ケーブルが1本添付されています。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>開発用パソコン</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>Arduino IDE と M5Stack 開発環境が整っていること。</p>
<p>セットアップ方法は <a href="https://soracom.github.io/iot-recipes/setup-for-m5stack-with-arduino-ide/" target="_blank">【SORACOM ハンズオン】M5Stack 開発環境セットアップ (Windows / macOS 共通) (全体で約90分)</a> をご覧ください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>(必要な方のみ)</p>
<p>USB 変換アダプタ</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>パソコンに USB Type-A ポートがない場合に準備してください。</p>
<p>1A 以上の電力が供給できるものを利用してください。(USB 3.0以上に対応していれば概ね安心です)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>(必要な方のみ)</p>
<p>USB Type-C ↔ Type-C ケーブル</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>パソコンに USB Type-A ポートが用意できず、また、USB 変換アダプタも用意できない場合に準備してください。</p>
</td></tr>
</table>
<p>※ 金額はレシピ作成時となります。ソラコムで販売している金額は税抜き・送料別です。その他は参考価格となります。</p>
<h2 is-upgraded>その他必要なもの</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>必要なもの</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>費用</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>作成方法など</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SORACOM アカウント</p>
</td><td colspan="1" rowspan="1"><p>無料※</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.github.io/iot-recipes/create-account-soracom-jp/" target="_blank">SORACOM アカウントの作成 (JP)</a></p>
</td></tr>
</table>
<p>※ アカウント作成・維持の費用の料金です。</p>
<h2 is-upgraded>設置に利用したもの</h2>
<p>本レシピで設置時に利用した部材です。必須ではありませんがご参考にお使いください。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>品名</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>数量</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>コーヒーマシン</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>今回は<a href="https://nestle.jp/brand/nba/lineup/i/" target="_blank">ネスカフェ ゴールドブレンド</a></p>
<p><a href="https://nestle.jp/brand/nba/lineup/i/" target="_blank">バリスタ i[アイ]</a>を利用しました。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>USB 型 AC アダプタ</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>M5Stack への電源供給用です。1A以上供給できるものが望ましいでしょう。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>USB Type-C ケーブル</p>
</td><td colspan="1" rowspan="1"><p>1</p>
</td><td colspan="1" rowspan="1"><p>M5Stack への電源供給用です。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>両面テープ</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td><td colspan="1" rowspan="1"><p>ToF 距離センサーの固定用です。</p>
</td></tr>
</table>


      </google-codelab-step>
    
      <google-codelab-step label="M5Stack 用 3G 拡張ボードに SIM を取り付ける" duration="15">
        <p>M5Stack 用 3G 拡張ボード(以下、3G拡張ボード)には SIM スロットが備わっており、ここに SIM を入れることで 3G 通信が可能となります。 SIM の取り付け・取り外しは 3G拡張ボードをケースから取り外す必要があります。</p>
<h2 is-upgraded>3G拡張ボードをケースから取り外す</h2>
<p>3G拡張ボードの四隅にあるネジを取り外します。ネジは紛失しないようにしてください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/55460decc2ab9d1f.png"></p>
<h2 is-upgraded>SIM を取り付ける（取り外し方法含む）</h2>
<p>SIM のサイズは nano です。取り付けはSIMをスロットに挿入したら「カチッ」と音が鳴るまで押し込みます。音が鳴ったら完了です。取り外しはSIMを奥まで押し込み「カチッ」と音が鳴ればSIMが出てきますので取り外しできます。</p>
<p class="image-container"><img style="width: 426.00px" src="img/f50325f437657f30.gif"></p>
<h2 is-upgraded>3G拡張ボードをケースに取り付ける</h2>
<p>再度3G拡張ボードをケースに取り付けます。取り付け向きはピンが外側 (ケースから飛び出るように) します。逆向き (ピンがケースの内側を向いてしまっている) には取り付け内でください。</p>
<p>最後はネジで固定します。</p>
<p class="image-container"><img style="width: 602.00px" src="img/6231353265f3e4e3.png"></p>
<aside class="special"><p><strong>M5Stack ボードの取り付け向き</strong></p>
<p>M5Stack は正方形であるためボードとケースの取り付け方角がわかりづらいのですが、ボード上のピン(M5-BUS と呼ばれる)の辺と、ケース側面の切れ込みの辺を合わせるようです。</p>
</aside>
<h2 is-upgraded>重ねる</h2>
<p>取り付け終わったら一番下から「BOTTOM」「3G拡張ボード」「Core※」と重ねていきます。</p>
<p>※ Core = M5Stack の LCD(モニター)やボタンがついているモジュール</p>
<p>以上で3G 拡張ボードへの SIM 取り付け作業は完了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Air を利用してセルラー通信をしてみる" duration="15">
        <p>3G 拡張ボードを使って SORACOM Air によるセルラー通信を行い、3G 拡張ボードの動作確認を行います。</p>
<h2 is-upgraded>セルラー通信ライブラリのインストール</h2>
<p>3G 拡張ボードで利用できる通信ライブラリをインストールします。今回は <a href="https://github.com/vshymanskyy/TinyGSM" target="_blank">TinyGSM</a> というオープンソースライブラリを利用して、世界時計を M5Stack で表示してみます。</p>
<h3 is-upgraded>Arduino IDE を開き、［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;TinyGSM&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>TinyGSM </strong>(by Volodymyr Shymanskyy) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/681ffa7927b99280.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;TinyGSM&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>tinygsm</code> と入力すると素早く見つけることができます。</p>
<p class="image-container"><img style="width: 587.00px" src="img/57e36a8bda8fcd71.png"></p>
</aside>
<h2 is-upgraded>World Time API を取得して表示するスケッチ</h2>
<p>動作テストを兼ねて世界時計を API で提供している <a href="http://worldtimeapi.org" target="_blank">World Time API</a> から日時を取得して表示します。 </p>
<aside class="special"><p><strong>ブラウザで試してみるには？</strong></p>
<p>World Time API を始めとした、いわゆる Web API はブラウザでも実行できることがあります。今回の World Time API であればブラウザで <a href="http://worldtimeapi.org/api/timezone/Asia/Tokyo.txt" target="_blank"><code>http://worldtimeapi.org/api/timezone/Asia/Tokyo.txt</code></a> を開いてみると、API で取得できる値をブラウザで表示できます。</p>
</aside>
<p>Arduino IDE を起動し［ファイル］&gt;［新規ファイル］を開くと <code>void setup() {</code> から始まる「空のスケッチ」が表示されます。</p>
<p>一度スケッチの内容を削除してから、後述のスケッチで置き換えてください。</p>
<p class="image-container"><img style="width: 849.70px" src="img/22e611963f846c4f.png"></p>
<h3 is-upgraded><a href="https://gist.github.com/ma2shita/abba497ebc2a4d93ca4b3e3bda2bb2fc" target="_blank">m5stack_3gextboard_worldclock.ino</a></h3>
<pre><code>/*
 * Copyright (c) 2020 SORACOM, INC.
 * Released under the MIT license
 * https://opensource.org/licenses/mit-license.php
*/
#include &lt;M5Stack.h&gt;

#define TINY_GSM_MODEM_UBLOX
#include &lt;TinyGsmClient.h&gt;

TinyGsm modem(Serial2); /* 3G board modem */
TinyGsmClient ctx(modem);

void setup() {
  Serial.begin(115200);
  M5.begin();
  M5.Lcd.clear(BLACK);
  M5.Lcd.setTextColor(WHITE);
  M5.Lcd.println(F(&#34;M5Stack + 3G Module&#34;));

  M5.Lcd.print(F(&#34;modem.restart()&#34;));
  Serial2.begin(115200, SERIAL_8N1, 16, 17);
  modem.restart();
  M5.Lcd.println(F(&#34;done&#34;));

  M5.Lcd.print(F(&#34;getModemInfo:&#34;));
  String modemInfo = modem.getModemInfo();
  M5.Lcd.println(modemInfo);

  M5.Lcd.print(F(&#34;waitForNetwork()&#34;));
  while (!modem.waitForNetwork()) M5.Lcd.print(&#34;.&#34;);
  M5.Lcd.println(F(&#34;Ok&#34;));

  M5.Lcd.print(F(&#34;gprsConnect(soracom.io)&#34;));
  modem.gprsConnect(&#34;soracom.io&#34;, &#34;sora&#34;, &#34;sora&#34;);
  M5.Lcd.println(F(&#34;done&#34;));

  M5.Lcd.print(F(&#34;isNetworkConnected()&#34;));
  while (!modem.isNetworkConnected()) M5.Lcd.print(&#34;.&#34;);
  M5.Lcd.println(F(&#34;Ok&#34;));

  M5.Lcd.print(F(&#34;My IP addr: &#34;));
  IPAddress ipaddr = modem.localIP();
  M5.Lcd.print(ipaddr);
  delay(2000);
}

void loop() {
  M5.update();

  M5.Lcd.clear(BLACK);
  M5.Lcd.setCursor(0, 0);
  M5.Lcd.println(F(&#34;World Clock from worldtimeapi.org&#34;));

  /* HTTP GET example */
  if (!ctx.connect(&#34;worldtimeapi.org&#34;, 80)) {
    Serial.println(F(&#34;Connect failed.&#34;));
    return;
  }
  Serial.println(F(&#34;connected.&#34;));

  /* send request */
  ctx.println(&#34;GET /api/timezone/Asia/Tokyo.txt HTTP/1.0&#34;);
  ctx.println(&#34;Host: worldtimeapi.org&#34;);
  ctx.println();
  Serial.println(&#34;sent.&#34;);

  /* receive response */
  while (ctx.connected()) {
    String line = ctx.readStringUntil(&#39;\n&#39;);
    Serial.println(line);
    if (line == &#34;\r&#34;) {
      Serial.println(&#34;headers received.&#34;);
      break;
    }
  }
  char buf[1 * 1024] = {0};
  ctx.readBytes(buf, sizeof(buf)); /* body */
  ctx.stop();
  M5.Lcd.println(buf);

  delay(1000 * 10);
}</code></pre>
<h2 is-upgraded>マイコンボードに書き込む</h2>
<p>M5Stack を PC に取り付けた後、Arduino IDE で<img style="width: 33.00px" src="img/6eda9a3a4a4958d7.png">ボタンをクリックします。<strong>ボードへの書き込みが完了しました。</strong>と表示されたら正常終了です。</p>
<aside class="special"><p><strong>ファイルの保存ダイアログが表示されたら</strong></p>
<p>ファイルを保存してください。ファイル名は任意ですが <code>m5stack_3gextboard_worldclock</code> というファイル名はどうでしょうか。</p>
<p>ファイルを保存しない (キャンセル) してもコンパイルとスケッチの転送はされます。</p>
</aside>
<h2 is-upgraded>実行の様子</h2>
<p>最初にモデムの型番や IP アドレスを表示した後に World Time API から取得したデータを表示します。</p>
<aside class="special"><p><code>gprsConnect(soracom.io)</code> から実際に IP アドレスが表示される(= 接続される)までに30~45秒程度掛かりますが正常です。</p>
</aside>
<p class="image-container"><img style="width: 602.00px" src="img/bc9d861d2195eaf6.png"></p>
<p class="image-container"><img style="width: 602.00px" src="img/512538b4a3fe59f8.png"></p>
<h2 is-upgraded>うまく動作しなかった場合</h2>
<table>
<tr><td colspan="1" rowspan="1"><p>症状</p>
</td><td colspan="1" rowspan="1"><p>考えられる原因</p>
</td><td colspan="1" rowspan="1"><p>対策</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><code>getModemInfo()</code> の結果が <code>SARA-U201...</code> と表示されない(空の場合など)</p>
</td><td colspan="1" rowspan="1"><p>3G 拡張ボードで内部エラーが発生している可能性がある</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.zendesk.com/hc/ja/requests/" target="_blank">カスタマーサポート</a>へご連絡ください。</p>
</td></tr>
<tr><td colspan="1" rowspan="5"><p><code>waitForNetwork()</code> より先に進まない</p>
</td><td colspan="1" rowspan="1"><p>電力が不足している</p>
</td><td colspan="1" rowspan="1"><p>USB Type-C ケーブルを別のものに変えてみてください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SIM が取り付けられていない。(もしくは SORACOM IoT SIM ではない)</p>
</td><td colspan="1" rowspan="1"><p>SORACOM 特定地域向け IoT SIM plan-D を取り付けてください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>電波が圏外もしくは微弱である可能性がある</p>
</td><td colspan="1" rowspan="1"><p>窓際等、通信条件が良い環境でお試しください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SIM が SORACOM に登録されていない</p>
<p>※ <a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>で確認できます ( &#34;登録されてない&#34; 事が確認できます)</p>
</td><td colspan="1" rowspan="1"><p><a href="https://soracom.github.io/iot-recipes/register-ordering-sim-jp/" target="_blank">発注済みの SIM を登録する</a> もしくは <a href="https://soracom.github.io/iot-recipes/register-byod-sim-jp/" target="_blank">通販サイトやイベント等で入手した SIM を登録する</a> を行ってください。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SIM の「状態」が &#34;準備完了&#34; となっている（ &#34;使用中&#34; でない）</p>
<p>※ <a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>で確認できます</p>
</td><td colspan="1" rowspan="1"><p>当該 SIM のチェックボックスをチェックしてから［操作］&gt;［使用開始］をクリックして &#34;使用中&#34; に変更してください。</p>
</td></tr>
</table>
<p>以上で M5Stack の開発環境から M5Stack 本体と 3G 拡張ボードの動作確認が完了しました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="ToF 距離センサーの取り付け" duration="10">
        <p>ToF 距離センサーは Grove ケーブルを使用して M5Stack 横の Grove ポートに接続します。</p>
<p>M5Stack からはUSBケーブルを抜き、電源がOFFの状態で作業してください。(USB ケーブルを抜いても内蔵バッテリーで動く場合がありますが、その時は M5Stack 側面の電源ボタンを素早く2回押してください)</p>
<h3 is-upgraded>ToF 距離センサー側</h3>
<p class="image-container"><img style="width: 370.50px" src="img/749b428873294101.png"></p>
<h3 is-upgraded>M5Stack 側</h3>
<p class="image-container"><img style="width: 359.50px" src="img/ea2d42689deb3630.png"></p>
<p>ToF センサーは M5Stack の底面に取り付けるのが良いでしょう。私は両面テープで取り付けました。</p>
<p class="image-container"><img style="width: 434.00px" src="img/399b7991eeb5bad.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="スケッチの書き込み" duration="15">
        <p>取り忘れをセンシングするスケッチを M5Stack へ書き込みます。</p>
<h2 is-upgraded>ToF 距離センサーライブラリのインストール</h2>
<p>M5Stack で ToF 距離センサーを利用するためのライブラリをインストールします。今回は<a href="https://github.com/pololu/vl53l0x-arduino" target="_blank">VL53L0X library for Arduino</a>というオープンソースライブラリを利用します。</p>
<h3 is-upgraded>Arduino IDE を開き、［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;VL53L0X&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>VL53L0X </strong>(by Pololu) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/6a533c1b0244694d.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;VL53L0X&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>VL53L0X</code> と入力すると素早く見つけることができます。Lのあとは数字の &#34;ゼロ&#34; です。似たようなライブラリが表示されるため <strong>by Pololu</strong> という表記を頼りに探してください。</p>
<p class="image-container"><img style="width: 587.00px" src="img/73da2291b20b1550.png"></p>
</aside>
<h2 is-upgraded>JSON 処理ライブラリのインストール</h2>
<p>M5Stack で JSON 形式の構造化テキストを処理するためのライブラリをインストールします。今回は<a href="https://arduinojson.org/?utm_source=meta&utm_medium=library.properties" target="_blank">ArduinoJson</a>というオープンソースライブラリを利用します。</p>
<h3 is-upgraded>Arduino IDE を開き、［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;ArduinoJson&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>ArduinoJson </strong>(by Benoit Blanchon) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/893f0cbb8a5d7f3c.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;ArduinoJson&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>arduinoJson</code> と入力すると素早く見つけることができます。</p>
</aside>
<h2 is-upgraded>HTTP 通信ライブラリのインストール</h2>
<p>M5Stack で HTTP 通信を行うライブラリをインストールします。今回は<a href="https://github.com/arduino-libraries/ArduinoHttpClient" target="_blank">ArduinoHttpClient</a>というオープンソースライブラリを利用します。</p>
<h3 is-upgraded>Arduino IDE を開き、［スケッチ］&gt;［ライブラリをインクルード］&gt;［ライブラリを管理...］をクリックします</h3>
<p class="image-container"><img style="width: 602.00px" src="img/41f6da411abfe840.png"></p>
<p>※ 画面は macOS ですが、Windows も同様です。</p>
<h3 is-upgraded>&#34;ArduinoHttpClient&#34; をインストールする</h3>
<p>ライブラリマネージャの一覧から <strong>ArduinoHttpClient </strong>(by Arduino) を選んで［インストール］をクリックします。</p>
<p>バージョンはインストール時における最新バージョンを選んでください。</p>
<p class="image-container"><img style="width: 602.00px" src="img/ac2bba6dd2038a7a.png"></p>
<p>インストールが終了したら［閉じる］をクリックします。</p>
<aside class="special"><p><strong>&#34;ArduinoHttpClient&#34; を簡単に探し出す方法</strong></p>
<p>検索用のテキストボックスへ <code>arduinoHttp</code> と入力すると素早く見つけることができます。似たようなライブラリが表示されるため <strong>by Arduino</strong> という表記を頼りに探してください。</p>
</aside>
<h2 is-upgraded>M5Stack へ書き込むスケッチを入手する</h2>
<p>Arduino IDE を起動し［ファイル］&gt;［新規ファイル］を開くと void setup() { から始まる「空のスケッチ」が表示されます。</p>
<p>書き込むスケッチは  <a href="https://gist.githubusercontent.com/ma2shita/6963154d5694323fbbb6bdd1c8ceb2ba/raw/838e099ba2363b7cd2562f1967b021bb1918e14d/m5stack_tof_ranger2.ino" target="_blank">m5stack_tof_ranger2.ino</a> です。(約280行ほどあるため、リンク先からスケッチを入手してください)</p>
<p>一度スケッチの内容を削除してから m5stack_tof_ranger2.ino の内容と置き換えてください。</p>
<p>※m5stack_tof_ranger2.ino の基となっている Gist (コード共有サイト) の URL は<a href="https://gist.github.com/ma2shita/6963154d5694323fbbb6bdd1c8ceb2ba" target="_blank">こちら</a>です。</p>
<h2 is-upgraded>マイコンボードに書き込む</h2>
<p>M5Stack を PC に取り付けた後、Arduino IDE で<img style="width: 33.00px" src="img/6eda9a3a4a4958d7.png">ボタンをクリックします。<strong>ボードへの書き込みが完了しました。</strong>と表示されたら正常終了です。</p>
<aside class="special"><p><strong>ファイルの保存ダイアログが表示されたら</strong></p>
<p>ファイルを保存してください。ファイル名は任意ですが <code>m5stack_tof_ranger</code> というファイル名はどうでしょうか。</p>
<p>ファイルを保存しない (キャンセル) してもコンパイルとスケッチの転送はされます。</p>
</aside>
<p>以上で書き込みは完了です。</p>
<p>書き込みが終わったら、M5Stack から USB ケーブルを外し、電源を OFF にしておきましょう。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Harvest Data の設定をする" duration="5">
        <p>M5Stack に取り付けた SIM に「SORACOM Harvest Data」の設定を行います。</p>
<h2 is-upgraded><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>の［Menu］&gt;［SIM 管理］とクリックして SIM 管理画面を開きます。</h2>
<p class="image-container"><img style="width: 566.00px" src="img/15d42beb5503d417.png"></p>
<aside class="warning"><p><strong>［SIM 管理］をクリックしても画面が切り替わらない場合は？</strong></p>
<p>すでに SIM 管理画面を開いている場合は、［SIM 管理］をクリックしても画面が切り替わることがありません。その場合、青の点線で囲まれている「SORACOM ロゴ」をクリックすることでメニューを閉じることができます。</p>
</aside>
<h2 is-upgraded>M5Stack に取り付けた SIM) にチェックを付け、［操作］&gt;［所属グループ変更］とクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/c06eff415539cb53.png"></p>
<aside class="special"><p><strong>SORACOM の便利な使い方: 複数の SIM を同時に扱う</strong></p>
<p>チェックをつける対象を複数にすれば、一度の複数の SIM を対象に操作が可能です。</p>
</aside>
<h2 is-upgraded>「新しい所属グループ」のプルダウンボックスをクリックした後、［新しいグループを作成...］をクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/9cf95365d7028f2c.png"></p>
<h2 is-upgraded>「グループ作成」のグループ名を入力して［グループ作成］をクリックします。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>例</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>グループ名</p>
</td><td colspan="1" rowspan="1"><p><code>poka-yoke-notifier</code></p>
</td><td colspan="1" rowspan="1"><p>自由に入力可能です。日本語も設定可能です。</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 385.00px" src="img/17d79112e7739a7b.png"></p>
<p class="image-container"><img style="width: 598.00px" src="img/8f66b433a8df7908.png"></p>
<h2 is-upgraded>SIM 管理画面で割り当てたグループ名をクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/ae57a6f509c22058.png"></p>
<h2 is-upgraded>［SORACOM Harvest Data 設定］をクリックして設定ができるように開きます。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/e29cf80f5c89ba1f.png"></p>
<h2 is-upgraded>「SORACOM Harvest Data 設定」で以下のように設定します。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>設定値</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>（スイッチ）</p>
</td><td colspan="1" rowspan="1"><p>ON</p>
</td><td colspan="1" rowspan="1"><p>スイッチはクリックすることで OFF から ON に切り替えることができます。</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 313.50px" src="img/5080f90e339b195.png"></p>
<p>その後［保存］をクリックしてください。<br>その後表示される「SORACOM Harvest Data が有効になっています」のダイアログでは［OK］をクリックしてください。</p>
<p>以上で「SORACOM Air メタデータサービス」と「SORACOM Harvest Data」の設定が完了しました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Harvest Data でデータを確認する" duration="10">
        <p>デバイスからのデータを SORACOM Harvest Data で確認します。</p>
<h2 is-upgraded><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>の［Menu］&gt;［SIM 管理］とクリックして SIM 管理画面を開きます。</h2>
<p class="image-container"><img style="width: 566.00px" src="img/15d42beb5503d417.png"></p>
<aside class="warning"><p><strong>［SIM 管理］をクリックしても画面が切り替わらない場合は？</strong></p>
<p>すでに SIM 管理画面を開いている場合は、［SIM 管理］をクリックしても画面が切り替わることがありません。その場合、青の点線で囲まれている「SORACOM ロゴ」をクリックすることでメニューを閉じることができます。</p>
</aside>
<h2 is-upgraded>M5Stack に取り付けた SIM) にチェックを付け、［操作］&gt;［データを確認］とクリックします。</h2>
<p class="image-container"><img style="width: 602.00px" src="img/b85c817ce051c1f0.png"></p>
<h2 is-upgraded>表示された画面で［自動更新］を ON にします。</h2>
<p>この表示された画面が SORACOM Harvest Data の画面となります。</p>
<aside class="special"><p><strong>自動更新とは？</strong></p>
<p>画面を再読み込みしなくとも新しいデータが自動的に表示されるようにする機能です。5秒毎に新しいデータを表示するようになります。この機能が OFF の場合は、表示する期間を指定して［検索］をクリックすることで期間内のデータを表示できます。</p>
</aside>
<p class="image-container"><img style="width: 602.00px" src="img/9b18d1a59196ae19.png"></p>
<h2 is-upgraded>設置後、M5Stack に USB ケーブルを接続して電源を ON にします</h2>
<p>実際に設置してみましょう。以下のように、コーヒーカップとの距離が計測しやすい位置に、ToF 距離センサーが向くように設置します。</p>
<p>この時、コーヒーカップの出し入れがしやすいことも合わせて確認しましょう。</p>
<p class="image-container"><img style="width: 601.70px" src="img/13062ef55f845557.png"></p>
<p>その後、M5StackにUSB ケーブルを接続して電源をONにします。既に電源がONだった場合、または、USBケーブルを接続しても電源がONにならない場合は、電源ボタンを 1 回押してみてください。リセットがかかり、電源がONになります。</p>
<h3 is-upgraded>M5Stackに表示される画面</h3>
<p>M5Stack の 電源 ON から 50~60秒程度すると、下記のような画面が表示されデータがクラウドに送信され始めます。</p>
<p class="image-container"><img style="width: 592.20px" src="img/9c5fb53d1cd9484.png"></p>
<h2 is-upgraded>コーヒーカップを置いて計測をしてみる</h2>
<p>先ほど書き込んだスケッチは3分毎にM5Stack とコーヒーカップの距離を mm でデータ送信するようになっています。実際にコーヒーカップを置いてみて、データが送信されるか確認します。</p>
<p>SORACOM Harvest Data では以下のように確認できます。コーヒーカップを置いて30分ほど経過した様子です。</p>
<p class="image-container"><img style="width: 602.00px" src="img/ff4fe2e145a2f9a5.png"></p>
<p>コーヒーカップとの距離が遠すぎる(700mm以上)もしくは近すぎる(15mm以下)の場合は Distance avg. は &#34;nan&#34; という値となり、クラウドへのデータ送信はされません。</p>
<p>以上でデータ送信の確認は終了です。</p>
<aside class="special"><p><strong>即座にデータ送信をしたい場合は？</strong></p>
<p>M5StackのBボタン(3つの並びの内真ん中のボタン)を押すと、即座にデータ送信されます。検証にお使いください。</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Lagoon でダッシュボードを作成する（有効化まで）" duration="10">
        <p>SORACOM Harvest Data に蓄積されたデータを SORACOM Lagoon で活用していきます。</p>
<h3 is-upgraded>SORACOM Lagoon 用語解説</h3>
<p>ここで SORACOM Lagoon で使われる用語を解説します。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>用語</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>意味</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>プラン</p>
</td><td colspan="1" rowspan="1"><p>SORACOM Lagoon の契約プランです。機能と料金が異なります。<a href="https://soracom.jp/services/lagoon/price/" target="_blank">SORACOM Lagoon のご利用料金</a>に機能や料金の比較表があります。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>メトリクス</p>
<p>(メトリック)</p>
</td><td colspan="1" rowspan="1"><p>データが格納されている先です。SORACOM Lagoon では以下の4つの中から選び、その中からノード(SIMや回線)を選択します。</p>
<ul>
<li>Air = SORACOM Air for セルラー</li>
<li>LoRa = SORACOM Air for LoRaWAN</li>
<li>Sigfox = SORACOM Air for Sigfox</li>
<li>Device = SORACOM Inventory デバイス</li>
</ul>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>データソース</p>
</td><td colspan="1" rowspan="1"><p>メトリクスの参照先です。SORACOM Lagoon では &#34;Harvest&#34; (= SORACOM Harvest) を選ぶとメトリクスが展開されます。 Grafana ではテスト用のランダムデータが表示されます。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>パネル</p>
</td><td colspan="1" rowspan="1"><p>パネルはデータを表示する領域です。データソースとメトリクスを指定すると、そのメトリクス(たとえばSIM)のデータをパネルで使えるようになります。</p>
<p>様々なパネルが存在します。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>ダッシュボード</p>
</td><td colspan="1" rowspan="1"><p>複数のパネルを束ねて「1枚の画面」にしたものがダッシュボードです。共有の単位となります。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SORACOM Lagoon ユーザー</p>
<p>(Lagoon ユーザー)</p>
</td><td colspan="1" rowspan="1"><p>SORACOM Lagoon へログインするためのユーザー(IDとパスワードの組)</p>
<p>SORACOM ユーザコンソールへのログインとは異なるユーザ一覧となり、皆さん自身で登録・削除が可能です。ダッシュボードやパネルを編集できる「編集可能」と表示専用の「読み取り」の2段階の権限を設定できます。</p>
<p>作成可能数はプランによります。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>データリフレッシュ</p>
</td><td colspan="1" rowspan="1"><p>SORACOM Harvest から SORACOM Lagoon へデータが反映される事、もしくは反映タイミングとなります。反映タイミングはプランによります。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>アラート</p>
</td><td colspan="1" rowspan="1"><p>メトリクスのデータに対して条件を設定し、その条件を満たしたら通知を行う仕組みの事です。</p>
</td></tr>
</table>
<h2 is-upgraded><a href="https://console.soracom.io/" target="_blank">SORACOM ユーザーコンソール</a>の［Menu］&gt;［データ収集・蓄積・可視化］&gt;［SORACOM Lagoon］とクリックします。</h2>
<p class="image-container"><img style="width: 547.00px" src="img/df078d78ef3c64c9.png"></p>
<h2 is-upgraded>［SORACOM Lagoon の利用を開始する］をクリックします。</h2>
<p class="image-container"><img style="width: 601.70px" src="img/61b4317bafcf36.png"></p>
<h2 is-upgraded>プランのうち［Free］を選択したあと［続行する］をクリックします。</h2>
<p class="image-container"><img style="width: 601.70px" src="img/ba7b1b86ad1370d3.png"></p>
<h2 is-upgraded>SORACOM Lagoon ユーザーの初期ユーザーに設定するパスワードを入力した後、［利用開始］をクリックします。</h2>
<p class="image-container"><img style="width: 601.70px" src="img/73b04598daf2437d.png"></p>
<aside class="special"><p><strong>SORACOM Lagoon ユーザーの初期ユーザの ID は？</strong></p>
<p>ID は SORACOM ユーザコンソールにログインしたときのメールアドレスが使われることになります。そのため、ここではパスワードのみ設定することになります。<strong>SORACOM ユーザコンソールへのログインとは異なるパスワードを設定する事を強くお勧めします。</strong></p>
</aside>
<aside class="warning"><p><strong>利用開始がクリックできない場合は？</strong></p>
<p>パスワードの条件が不足しています。全てに✔がつくようにパスワードを設定してください。</p>
</aside>
<p>SORACOM Lagoon の有効化に成功すると、以下のように SORACOM Lagoon コンソールへのリンクと、Lagoon ユーザーの一覧が管理できるようになります。</p>
<p>この画面を SORACOM Lagoon 管理画面と呼びます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/855b7e3d4b3f16b4.png"></p>
<p>SORACOM Lagoon 管理画面は、SORACOM Lagoon が有効化されている間は ［Menu］&gt;［データ収集・蓄積・可視化］&gt;［SORACOM Lagoon］で表示する事ができます。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Lagoon でダッシュボードを作成する（SORACOM Lagoon へのログインまで）" duration="5">
        <h2 is-upgraded>SORACOM Lagoon 管理画面を表示したあと、［SORACOM Lagoon console にアクセス］をクリックします。</h2>
<p>※ SORACOM Lagoon 管理画面は ［Menu］&gt;［データ収集・蓄積・可視化］&gt;［SORACOM Lagoon］で表示する事ができます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/50318e0cbcdd8d18.png"></p>
<h2 is-upgraded>SORACOM Lagoon へログインします。</h2>
<p>メールアドレス (SORACOM ユーザコンソールへログインする際のメールアドレス) と、SORACOM Lagoon 初期ユーザ作成時に利用したパスワードでログインします。</p>
<p class="image-container"><img style="width: 601.70px" src="img/b115170f4eae4b7c.png"></p>
<p>ログインに成功すると、以下のような画面が表示されます。これが SORACOM Lagoon ログイン直後の画面です。ここから「ダッシュボード」や「パネル」を作成していきます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/8982b084f57fc659.png"></p>
<aside class="special"><p><strong>背景を白くしたい</strong></p>
<p>SORACOM Lagoon の標準では背景が黒となっています。これは設定で変更が可能です。</p>
<p>右下のアイコンにカーソルを合わせて表示される［設定］をクリックします。</p>
<p class="image-container"><img style="width: 342.00px" src="img/8cec8a9120d25dcd.png"></p>
<p>設定画面に &#34;テーマ&#34; を &#34;Light&#34; に変更して［保存］すると、背景が白くなります。</p>
<p class="image-container"><img style="width: 502.00px" src="img/69d5628454a7662a.png"></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Lagoon でダッシュボードを作成する（アラートの作成まで）" duration="5">
        <p>通知先を設定します。</p>
<h2 is-upgraded>アラートアイコン<img style="width: 52.00px" src="img/929c5a290c1b2b20.png">にカーソルを乗せると表示される「アラート」メニューから［通知チャンネル］をクリックします。</h2>
<p class="image-container"><img style="width: 300.00px" src="img/7f2e92ac97094e6d.png"></p>
<h2 is-upgraded>［チャンネルを作成］をクリックします。</h2>
<p class="image-container"><img style="width: 552.00px" src="img/d51a4a26dfc3e897.png"></p>
<h2 is-upgraded>「Alerting」では以下の通りに入力します。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>内容</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>備考</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>名前</p>
</td><td colspan="1" rowspan="1"><p><code>email</code></p>
</td><td colspan="1" rowspan="1"><p>任意の名称で構いません。</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>タイプ</p>
</td><td colspan="1" rowspan="1"><p>Email</p>
</td><td colspan="1" rowspan="1"><p>―</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Email addresses</p>
</td><td colspan="1" rowspan="1"><p>通知の送付先メールアドレス</p>
</td><td colspan="1" rowspan="1"><p>; で複数指定が可能です。</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 380.00px" src="img/76acb94532757b86.png"></p>
<p>入力し終わったら［保存］をクリックします。</p>
<aside class="special"><p><strong>［送信テスト］について</strong></p>
<p>保存の前に［送信テスト］にてテストが行えます。テストを行うと以下のようなメールが届きますので、確認にご利用ください。</p>
<p>また、メールが届かない場合の確認ポイントは以下の通りです。</p>
<ul>
<li>メールアドレスが正しいこと</li>
<li><code>no-reply@soracom.jp</code> からのメールが迷惑メールに判定されてないこと、もしくは受信フィルタで拒否されていないこと</li>
</ul>
<p class="image-container"><img style="width: 587.00px" src="img/48b63cb9a997e1d.png"></p>
</aside>
<h3 is-upgraded>以下のように表示されていれば成功です。</h3>
<p class="image-container"><img style="width: 601.70px" src="img/75d9f2d124017aad.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Lagoon でダッシュボードを作成する（ダッシュボードのインポートまで）" duration="5">
        <p>あらかじめ設定が済んでいるテンプレートを使ってダッシュボードを作成します。</p>
<h2 is-upgraded>ダッシュボードアイコン<img style="width: 41.00px" src="img/1a2fb10a70407aa4.png">にカーソルを乗せると表示される「ダッシュボード」メニューから［管理］をクリックします。</h2>
<p class="image-container"><img style="width: 322.00px" src="img/f480623e992e3b37.png"></p>
<h2 is-upgraded>［Import］をクリックします。</h2>
<p class="image-container"><img style="width: 601.70px" src="img/e3f1768fea3b586f.png"></p>
<h2 is-upgraded>［Or paste JSON］のテキストボックスへ、以下のテキストを入力(貼り付け)ます。</h2>
<p>貼り付けるテキストは <a href="https://gist.githubusercontent.com/ma2shita/28ae5bbb2b1f0f76b08872ff2132d636/raw/98b4d666ec803668c96ade93d65ff4c427cabb03/lagoon_template_for_m5stack_tof_ranger2.json" target="_blank">lagoon_template_for_m5stack_tof_ranger2.json</a> です。(約200行ほどあるため、リンク先から定義を入手してください)</p>
<p>※lagoon_template_for_m5stack_tof_ranger2.json の基となっている Gist (コード共有サイト) の URL は<a href="https://gist.github.com/ma2shita/28ae5bbb2b1f0f76b08872ff2132d636" target="_blank">こちら</a>です。</p>
<p class="image-container"><img style="width: 586.00px" src="img/253a0896f71b9ecc.png"></p>
<p>貼り付けたら［Load］をクリックします。</p>
<aside class="warning"><p><strong>Load をクリックすると &#34;Unexpected end of JSON input&#34; と表示される</strong></p>
<p>テキストが上手く入力できていない場合は<img style="width: 338.00px" src="img/c98e8561cb2ab941.png">と表示されます。</p>
<p>貼り付けたテキストを見直すようにしてください。</p>
</aside>
<h2 is-upgraded>Options では以下のようになっていることを確認します。</h2>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>内容</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Name</p>
</td><td colspan="1" rowspan="1"><p>コーヒーカップ取り忘れ防止</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>フォルダ</p>
</td><td colspan="1" rowspan="1"><p>General</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Unique Identifier (uid)</p>
</td><td colspan="1" rowspan="1"><p>auto generated</p>
</td></tr>
</table>
<p class="image-container"><img style="width: 601.70px" src="img/2068df7b21925e42.png"></p>
<p>確認できたら［Import］をクリックします。</p>
<h3 is-upgraded>以下のように表示されていれば成功です。</h3>
<p class="image-container"><img style="width: 601.70px" src="img/5fa4d1ecc55125bb.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM Lagoon でダッシュボードを作成する（パネルの編集からダッシュボードの保存まで）" duration="5">
        <h2 is-upgraded>&#34;コーヒーカップとの距離履歴&#34; &gt;［編集］をクリックします。</h2>
<p class="image-container"><img style="width: 387.94px" src="img/a894d56b5c9147a2.png"></p>
<h2 is-upgraded>&#34;メトリック&#34; タブで読み込むデータを設定します</h2>
<p>&#34;メトリック&#34; タブが表示されている（もしくは &#34;メトリック&#34; タブを選択した後）、以下の設定を行います。</p>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>設定項目</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>値</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>データソース</p>
</td><td colspan="1" rowspan="1"><p>default</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>&#34;A metric&#34; と表示されている行の左から2番名のプルダウン</p>
</td><td colspan="1" rowspan="1"><p>M5Stack に取り付けた SIM</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>&#34;A metric&#34; と表示されている行の一番右のプルダウン</p>
</td><td colspan="1" rowspan="1"><p>avg_mm</p>
</td></tr>
</table>
<p>選んだ時点で、全データが表示されます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/720fc4eb61e3ce3d.png"></p>
<aside class="special"><p><strong>プルダウンに &#34;M5Stack&#34; が無い？</strong></p>
<p>左から2番目のプルダウンについては、参考画像上では &#34;M5Stack&#34; と表示されていますが、これはSORACOM ユーザーコンソール上で SIM に名前を付けているからです。名前がついていない場合は SIM の IMSI (回線識別用の15桁の番号) が表示されます。</p>
</aside>
<aside class="special"><p><strong>データが表示されていない？</strong></p>
<p>データを蓄積し始めてから間もない場合、グラフの右端に「少しだけ」表示されている場合があります。これは、パネルの表示時間の標準が「過去6時間分」を表示するようになっているからです。</p>
<p class="image-container"><img style="width: 601.70px" src="img/c64ecf6711bfd65a.png"></p>
<p>右上の「時間」ボタンで表示範囲を設定可能です。まずは「過去15分間」くらいが良いでしょう。</p>
<p class="image-container"><img style="width: 587.00px" src="img/76a64d941a095f3.png"></p>
<p>それでもデータが表示されていない場合は、いったん SORACOM Harvest Data データの蓄積具合を確認するようにしてください。</p>
</aside>
<h2 is-upgraded>&#34;アラート&#34; タブをクリックした後［通知］をクリックします。</h2>
<p class="image-container"><img style="width: 601.70px" src="img/5b59a97c9134624.png"></p>
<h2 is-upgraded>［送り先］の<img style="width: 38.00px" src="img/38ead9633ff579b.png">をクリックし、先ほど作成した通知先 (例に沿っているなら email)を選択します。</h2>
<p class="image-container"><img style="width: 461.00px" src="img/1627263c7ba96541.png"></p>
<p class="image-container"><img style="width: 458.00px" src="img/5c1307fb1ea897b.png"></p>
<h2 is-upgraded>画面右上のダッシュボードに戻る<img style="width: 54.00px" src="img/2c69286f16fd7716.png">ボタンをクリックします。</h2>
<p class="image-container"><img style="width: 493.00px" src="img/9196ca6f166013da.png"></p>
<h2 is-upgraded>画面右上の<img style="width: 26.00px" src="img/50a8bb4168fb4b7d.png">をクリックすることでこれまでの作業を保存できます。</h2>
<h3 is-upgraded><img style="width: 601.70px" src="img/389492df4f299b03.png"></h3>
<p>［保存］で保存します。</p>
<p class="image-container"><img style="width: 531.00px" src="img/234397285cc0bde9.png"></p>
<p>以上で全ての設定が終了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="メールを確認してみる" duration="1">
        <p>M5Stack がコーヒーカップの存在を検出すると、「Alerting」と書かれたメールが通知チャンネルで設定したメールアドレスに届きます。</p>
<p class="image-container"><img style="width: 602.00px" src="img/10b9987e1a0afa20.png"></p>
<p>また、コーヒーカップを取ると以下のように「OK」と書かれたメールが届きます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/75597861a983e09e.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="その他の機能や運用に向けた設定" duration="1">
        <p>ここからは、これまで紹介していなかった機能や、本番に向けた設定を紹介します。</p>
<h2 is-upgraded>アラートとなる距離の設定方法</h2>
<p>本レシピの仕組みはコーヒーカップまでの距離を計測することで有無を判定しています。</p>
<p class="image-container"><img style="width: 601.70px" src="img/ab8ed2d4107399c3.png"></p>
<p>本レシピの標準設定はM5Stackからカップまでの距離が25mm以上 70mm以下であるときに「ある」と判定するようになっています。</p>
<p>下の図における赤い帯が「ある」と判定される距離範囲となります。</p>
<p class="image-container"><img style="width: 601.70px" src="img/6274fd0365033d7b.png"></p>
<p>一方、利用するコーヒーメーカーやカップのサイズなど、設置条件は様々であるため調整が必要となります。判定は SORACOM Lagoon の「アラート」機能であり、検出条件はここで変更できます。</p>
<p class="image-container"><img style="width: 601.70px" src="img/587f5c876a399b13.png"></p>
<aside class="special"><p><strong>判定条件が範囲指定となっているわけ</strong></p>
<p>カップを置く位置は常に一定だとは限りません。また、センサー自体も多少の誤差を持っています。そのため、誤差を吸収する仕組みとして範囲指定をしています。</p>
<p class="image-container"><img style="width: 587.00px" src="img/8261a0bbf63d3f59.png"></p>
</aside>
<h2 is-upgraded>LCD (液晶)画面の消灯</h2>
<p>M5Stack の LCD 画面は C ボタン(一番右のボタン)を押すことで、消灯することができます。消灯後、再度 C ボタンを押すと点灯します。</p>
<p class="image-container"><img style="width: 475.50px" src="img/112768e9fe4d4cb5.png"></p>
<h2 is-upgraded>計測モード</h2>
<p>ToFセンサーの動作を確認するための「計測モード」が実装されています。</p>
<p>M5Stack の A ボタン(一番左のボタン)を押しながら、電源ボタン(側面のボタン)を押してください。Skip fetching config from Cloud と表示され、すぐにメイン画面に移行します。(A ボタンはこの時点で離すことができます。</p>
<p class="image-container"><img style="width: 475.50px" src="img/ad9277c11680b1e8.png"></p>
<p>Notification のカウントダウンはされますが、クラウドとの通信は行いません。</p>
<p>クラウドとの通信を行うモードにするためには、電源ボタンを押してリセットしてください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="あとかたづけと注意事項" duration="1">
        <p>本レシピでは費用がかかるサービスを利用しています。<br>本項をよく読み、必要な操作や解除作業を行うようにして、想定外の費用が掛からないようにしてください。</p>
<h2 is-upgraded>費用について</h2>
<p>ここで記載している金額は全て税別、送料別となります。</p>
<h3 is-upgraded>SORACOM プラットフォームの利用料金</h3>
<table>
<tr><td colspan="1" rowspan="1"><p><strong>サービス／機能</strong></p>
</td><td colspan="1" rowspan="1"><p><strong>料金</strong></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/services/air/cellular/price_specific_area_sim/" target="_blank">SORACOM Air (plan-D)</a></p>
</td><td colspan="1" rowspan="1"><ul>
<li>基本料: 10円/日</li>
<li>通信料: 0.2円~/MB</li>
</ul>
<p>(今回の利用であれば 1MB 以内で収まる範囲)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/services/harvest/price/" target="_blank">SORACOM Harvest Data</a></p>
</td><td colspan="1" rowspan="1"><ul>
<li>本機能を有効にしたグループに所属する1SIMあたり5円/日 (2000リクエスト/日/SIMを含む)</li>
<li>2000リクエスト/日を超えた分は0.004円/リクエスト</li>
</ul>
</td></tr>
<tr><td colspan="1" rowspan="1"><p><a href="https://soracom.jp/services/lagoon/price/" target="_blank">SORACOM Lagoon</a></p>
</td><td colspan="1" rowspan="1"><p>今回は Free プラン(無料)を使用しました。</p>
</td></tr>
</table>
<aside class="special"><p><strong>無料利用枠について</strong></p>
<p>SORACOM サービスでは一部サービスにおいて無料枠が設定されています。たとえば SORACOM Air for セルラーであればアカウント毎で30円/月の通信分や、SORACOM Harvest Data であれば31日分の書込みリクエストなどです。料金詳細に「無料利用枠」として掲載されていますので、ご確認ください。</p>
</aside>
<h2 is-upgraded>グループ解除</h2>
<p>SORACOM Harvest Data 等、「機能が有効になっているグループに所属している SIM × 費用」となっているサービスにおいては、「機能を OFF にする」することで費用の発生を抑えることができます。またもう1つの方法として「グループに所属している SIM の数を減らす(= 解除する)」事でも費用を抑える事ができます。</p>
<p>グループ解除の方法は<a href="https://soracom.github.io/iot-recipes/unjoin-from-group/" target="_blank">グループからの解除 (JP)</a>をご覧ください。</p>
<h2 is-upgraded>SORACOM Harvest Data のデータ削除（任意）</h2>
<p>SORACOM Harvest Data は基本的にはデータ保管料は無料※です。そのため、保存しておいても害はありませんが、デモ等で利用する際にはデータを綺麗にしておく必要が出てくるため、データ削除について解説します。</p>
<p>※発生から40日を超えたデータは削除されます。40日以上データを保管したい場合は<a href="https://soracom.jp/services/harvest/price/" target="_blank">データ保持期間延長オプション利用料金</a>をご利用ください。</p>
<p>SORACOM Harvest Data 画面 (［操作］&gt;［データを確認］) のデータテーブルで、削除したいデータのチェックボックスを付けた後に［削除］をクリックします。表示されたダイアログで改めて［削除］をクリックすると、削除されます。<br>※ 複数のデータにチェックをつければ一括で削除可能です。</p>
<p class="image-container"><img style="width: 414.00px" src="img/637cac3bf206c47c.png"></p>
<p><strong>データの復元はできません</strong>のでご注意ください。</p>
<h2 is-upgraded>SORACOM Lagoon の解約</h2>
<p>SORACOM Lagoon はオンラインで解約が可能です。 Free プランであれば有効化しておいても費用は発生しませんが、長期に渡って利用しない場合には解約も選択いただけます。</p>
<p>解約の方法は<a href="https://soracom.github.io/iot-recipes/disable-soracom-lagoon" target="_blank">SORACOM Lagoon の解約(JP)</a>をご覧ください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="次のステップ" duration="1">
        <p>本レシピでは、M5Stack と 3G 拡張ボードと ToF 距離センサーを組み合わせた「コーヒーカップ取り忘れ通知デバイス」を作りました。</p>
<p>「距離」によるセンシングは、計測される側（今回はコーヒーカップ）の改造をせずとも物体の有無を簡単に判定できることから、応用例も多く考えられるのではないでしょうか？</p>
<p>今回は ToF 距離センサーを利用しましたが、その他にも<a href="https://www.switch-science.com/catalog/1383/" target="_blank">超音波を利用した距離センサー</a>もあります。センシングする対象や環境に応じて使い分けることもできるでしょう。</p>
<p><a href="https://soracom.jp/products/kit/3g_module_m5stack_set/" target="_blank">商品ページへ戻る</a></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://soracom.github.io/iot-recipes/codelab-elements/native-shim.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/custom-elements.min.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/prettify.js"></script>
  <script src="https://soracom.github.io/iot-recipes/codelab-elements/codelab-elements.js"></script>

</body>
</html>
